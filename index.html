<!DOCTYPE html>
<html>

<head>
    <!-- Required meta tags-->
    <meta charset="utf-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- Color theme for statusbar (Android only) -->
    <meta name="theme-color" content="#2196f3">
    <!-- Your app title -->
    <title>Frango da Mama</title>
    <!-- Path to Framework7 Library Bundle CSS -->
    <link rel="stylesheet" href="lib/framework7-bundle.min.css">
    <!-- CSS PERSONALIZADO PARA MENU-->
    <link rel="stylesheet" href="css/index.css">
    <!--√çcones Material Design-->
    <link rel="stylesheet" href="css/materialdesignicons.min.css">
    <!--√çcones Material Design-->
    <link rel="stylesheet" href="css/remixicon.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<!-- Colar logo antes de carregar os scripts principais (p.ex. antes de framework7-bundle.min.js) -->
<script>
  // Universal loading overlay ‚Äî se o Framework7 existir, usa o preloader; sen√£o, mostra overlay custom
  function showLoading(text) {
    try {
      if (window.app && app.preloader && typeof app.preloader.show === 'function') {
        app.preloader.show();
        return;
      }
    } catch(e){ /* ignore */ }

    if (!document.getElementById('sys-loader')) {
      const ov = document.createElement('div');
      ov.id = 'sys-loader';
      ov.style.position = 'fixed';
      ov.style.left = '0';
      ov.style.top = '0';
      ov.style.right = '0';
      ov.style.bottom = '0';
      ov.style.background = 'rgba(0,0,0,0.45)';
      ov.style.zIndex = 99999;
      ov.style.display = 'flex';
      ov.style.alignItems = 'center';
      ov.style.justifyContent = 'center';
      ov.innerHTML = `<div style="background:#fff;padding:14px 18px;border-radius:10px;display:flex;align-items:center;gap:12px">
        <div class="spin" style="width:22px;height:22px;border:3px solid #ddd;border-top-color:#333;border-radius:50%;animation:spin 0.8s linear infinite"></div>
        <div style="font-weight:600;color:#222">${text||'Carregando...'}</div>
      </div>`;
      document.body.appendChild(ov);
      const s = document.createElement('style');
      s.innerHTML = `@keyframes spin{to{transform:rotate(360deg)}}`;
      document.head.appendChild(s);
    } else {
      const ov = document.getElementById('sys-loader');
      ov.style.display = 'flex';
      // atualiza texto se quiser (procura o div de texto no overlay)
      const textDiv = ov.querySelector('div > div:last-child');
      if (textDiv) textDiv.textContent = text || 'Carregando...';
    }
  }

  function hideLoading() {
    try {
      if (window.app && app.preloader && typeof app.preloader.hide === 'function') {
        app.preloader.hide();
        return;
      }
    } catch(e) { /* ignore */ }

    const ov = document.getElementById('sys-loader');
    if (ov) ov.style.display = 'none';
  }
</script>


</head>

<body>

    <div id="login-screen" class="login-container">
      <h2 class="login-title">Login</h2>
      <input id="login-username" type="text" placeholder="Usu√°rio" class="login-input">
      <input id="login-password" type="password" placeholder="Senha" class="login-input">
      <button id="loginBtn" onclick="realizarLogin()">Entrar</button>
      <p id="login-error" class="login-error"></p>
    </div>




    <!-- App root element -->
    <div id="app">
    <!-- <div id="app" style="display:none;"></div> -->
      
        <!-- Popup para adicionar produto -->

        <div class="popup popup-produto custom-popup-anim" id="popup-add-pedido">
          <div class="view"><div class="page">
            <div class="navbar"><div class="navbar-inner">
              <div class="title">Novo Pedido</div>
              <div class="right"><a href="#" class="link popup-close icon-only"><i class="ri-close-line"></i></a></div>
            </div>
          </div>

             <div class="page-content">
              <div class="block">
                <div class="list no-hairlines-md">
                  <ul>
                    <!-- Frango -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">
                          <label><input type="checkbox" id="chk-frango"> Frango Assado (R$49,90)</label>
                        </div>
                        <div class="item-input-wrap">
                          <input type="number" id="qtd-frango" min="0" value="0" disabled />
                        </div>
                      </div>
                    </li>

                    <!-- Coxa -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">
                          <label><input type="checkbox" id="chk-coxa"> Coxa-Sobrecoxa (R$9,90)</label>
                        </div>
                        <div class="item-input-wrap">
                          <input type="number" id="qtd-coxa" min="0" value="0" disabled />
                        </div>
                      </div>
                    </li>

                    <!-- Refrigerantes livre -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Refrigerantes (ex: "2 Coca 2L, 1 Guaran√° 1L")</div>
                        <div class="item-input-wrap">
                          <input type="text" id="input-refrigerantes" placeholder="Ex: 2 Coca 2L, 1 Guaran√° 1L">
                        </div>
                      </div>
                    </li>

                    <!-- Arroz -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">
                          <label><input type="checkbox" id="chk-arroz"> Arroz (R$8,00)</label>
                        </div>
                        <div class="item-input-wrap">
                          <input type="number" id="qtd-arroz" min="0" value="0" disabled />
                        </div>
                      </div>
                    </li>

                    <!-- Acr√©scimo / Desconto (valor em R$) -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Acr√©scimo / Desconto (R$)</div>
                        <div class="item-input-wrap">
                          <input type="number" id="input-acrescimo" step="0.01" value="0.00" placeholder="Ex: 5.00 ou -2.50" />
                        </div>
                      </div>
                    </li>

                    <!-- Observa√ß√µes (campo livre) -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Observa√ß√µes</div>
                        <div class="item-input-wrap">
                          <textarea id="input-obs" placeholder="Observa√ß√µes do pedido (ex: sem cebola, entrega na porta)"></textarea>
                        </div>
                      </div>
                    </li>

                    <!-- Nome -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Nome do Cliente</div>
                        <div class="item-input-wrap">
                          <input type="text" id="input-nome-cliente" placeholder="Nome" />
                        </div>
                      </div>
                    </li>

                    <!-- Endere√ßo -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Rua</div>
                        <div class="item-input-wrap">
                          <input type="text" id="input-endereco" placeholder="Digite o nome da rua" />
                        </div>
                      </div>
                    </li>

                    <!-- N√∫mero -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">N√∫mero</div>
                        <div class="item-input-wrap">
                          <input type="text" id="input-numero" placeholder="N√∫mero" />
                        </div>
                      </div>
                    </li>

                    <!-- CEP -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">CEP</div>
                        <div class="item-input-wrap">
                          <input type="text" id="input-cep" placeholder="CEP ser√° preenchido automaticamente" readonly />
                        </div>
                      </div>
                    </li>

                    <!-- Cidade -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Cidade</div>
                        <div class="item-input-wrap">
                          <input type="text" id="input-cidade" value="Ribeir√£o Preto" readonly />
                        </div>
                      </div>
                    </li>

                    <!-- UF -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">UF</div>
                        <div class="item-input-wrap">
                          <input type="text" id="input-uf" value="SP" readonly />
                        </div>
                      </div>
                    </li>

                    <!-- Hor√°rio -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Hor√°rio de Entrega</div>
                        <div class="item-input-wrap">
                          <input id="input-horario-entrega" type="datetime-local" />
                        </div>
                      </div>
                    </li>

                    <!-- Pre√ßo total -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Pre√ßo Total (R$)</div>
                        <div class="item-input-wrap">
                          <input type="number" id="input-preco-total" readonly />
                        </div>
                      </div>
                    </li>
                  </ul>
                </div>

                <div class="block">
                  <a href="#" class="button button-fill" id="btn-add-pedido">Adicionar Pedido</a>
                </div>
              </div>
            </div>

          </div></div>
        </div>


        <!-- Your main view, should have "view-main" class -->
        <div class="view view-main">
          <div class="toolbar toolbar-bottom">
            <div class="toolbar-inner display-flex">
              <a href="/loadingindex/" class="tab-link link active"><i class="ri-restaurant-line"></i><span>Pedidos</span></a>
              <a href="/loadinglink2/" class="tab-link link"><i class="ri-map-pin-line"></i><span>Rotas</span></a>
              <a href="/loadinglink3/" class="tab-link link"><i class="ri-wallet-3-line"></i><span>Financeiro</span></a>
              <a href="/loadinglink4/" class="tab-link link"><i class="ri-settings-3-line"></i><span>Configura√ß√µes</span></a>
            </div>
          </div>

          <div data-name="index" class="page color-theme-blue">
            <div class="navbar"><div class="navbar-bg"></div><div class="navbar-inner">
              <div class="left">
                <a href="#" class="link icon-only popup-open" data-popup="#popup-add-pedido">
                  <i class="ri-add-line"></i>
                </a>
              </div>
              <div class="title" id="app-title">Frango da Mama</div>
              <div class="right">
                <a href="#" class="link icon-only" id="btnBuscar"><i id="searchIcon" class="ri-filter-3-line"></i></a>
              </div>
            </div></div>

            <div class="page-content ptr-content">
              <div id="preloader" style="display:none;text-align:center;margin:20px 0;"><div class="preloader"></div></div>
              <div id="produtos" class="block grid grid-cols-1 gap-2 card-list" style="padding:10px;"></div>
            </div>
          </div>
        </div>
      </div>

    <!-- Production widget (floating) -->
    <div id="production-widget" aria-hidden="false">
      <div id="production-panel" role="dialog" aria-label="Produ√ß√£o e vendas do dia">
        <div class="prod-row"><div class="prod-label">üêî Frango</div><div class="prod-value" id="pv-frango">0 / 0</div></div>
        <div class="prod-row"><div class="prod-label">üçó Coxa</div><div class="prod-value" id="pv-coxa">0 / 0</div></div>
        <div class="prod-row"><div class="prod-label">ü•§ Refrigerante</div><div class="prod-value" id="pv-refri">0 / 0</div></div>

        <div class="actions">
          <div style="display:flex; gap:6px;">
            <button id="btn-edit-produzidos" class="small-btn">Editar</button>
            <!-- <button id="btn-reset-produzidos" class="small-btn" title="Limpar produzidos do dia">Reset</button> -->
          </div>
          <button id="btn-close-productions" class="link-text">‚ùå</button>
        </div>

        <div id="produzidos-edit" style="display:none; margin-top:8px;">
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px;">
            <label style="min-width:80px;">üêî Frangos</label>
            <input type="number" id="inp-prod-frango" min="0" value="0">
          </div>
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px;">
            <label style="min-width:80px;">üçó Coxas</label>
            <input type="number" id="inp-prod-coxa" min="0" value="0">
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <label style="min-width:80px;">ü•§ Refris</label>
            <input type="number" id="inp-prod-refri" min="0" value="0">
          </div>
          <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
            <button id="btn-save-produzidos" class="small-btn">Salvar</button>
            <button id="btn-cancel-produzidos" class="small-btn">Cancelar</button>
          </div>
        </div>
      </div>

      <div id="production-toggle" title="Produ√ß√£o e Vendas">üìä</div>
    </div>
  
    <!-- Path to Framework7 Library Bundle JS-->
    <script type="text/javascript" src="lib/framework7-bundle.min.js"></script>
	  <!-- jQuery -->
	  <script type="text/javascript" src="lib/jquery-3.7.0.min.js"></script>	
    <script src="js/funcoes.js"></script>
    <!-- Roteamento do app-->
    <script type="text/javascript" src="js/routes.js"></script>
    <script src="cordova.js"></script>

    <script>
      app.ptr.done(); // usa o app j√° existente
  
      // Usar Dom7 (o "jQuery" do Framework7)
      var $$ = Dom7;
  
      // Evento quando o usu√°rio puxa para atualizar
      $$('.ptr-content').on('ptr:pullstart', function (e) {
        // Quando come√ßa a puxar, mostra preloader
        $$('#preloader').show();
      });

      $$('.ptr-content').on('ptr:pullmove', function (e, distance) {
        // Opcional: voc√™ pode ajustar a opacidade ou o tamanho do preloader conforme a dist√¢ncia
        const max = 100; // distancia m√°xima considerada
        const perc = Math.min(distance / max, 1);
        $$('#preloader').css('opacity', perc);
      });

      $$('.ptr-content').on('ptr:pullend', function (e) {
        // Quando o usu√°rio solta, restaura opacidade
        $$('#preloader').css('opacity', 1);
      });

      $$('.ptr-content').on('ptr:refresh', function (e) {
        // Simula carregamento
        setTimeout(function () {
            if (window.carregarPedidosDoDia) window.carregarPedidosDoDia();
            $$('#preloader').hide();
            app.ptr.done();
        }, 1500);
      });


    </script>

    <script>

      document.addEventListener('DOMContentLoaded', function () {
        // Mostrar preloader inicialmente
        $$('#preloader').show();

        // Simula um delay (voc√™ pode remover o setTimeout depois se quiser)
        setTimeout(() => {
          $$('#preloader').hide(); // Esconde o preloader depois do carregamento
        }, 2000); // tempo simulado para carregamento
      });

      // Esconde os cards ao sair da p√°gina index
      $$(document).on('page:beforeout', '.page[data-name="index"]', function () {
        console.log('Saindo da index, ocultando cards');
        $$('#produtos').hide();
      });

      // Mostra os cards ao retornar para a p√°gina index
      $$(document).on('page:afterin', '.page[data-name="index"]', function () {
        console.log('Voltando para index, mostrando cards');
        $$('#produtos').show();
      });
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Verifica se o usu√°rio j√° est√° logado na sess√£o atual
        const logado = sessionStorage.getItem("usuarioLogado");

        if (logado === "true") {
          // Oculta a tela de login e mostra o conte√∫do
          document.getElementById("login-screen").style.display = "none";
          //document.getElementById("app-content").style.display = "block";
        } else {
          // Mostra a tela de login
          document.getElementById("login-screen").style.display = "block";
          //document.getElementById("app-content").style.display = "none";
        }
      });

function realizarLogin() {
  var usuario = document.getElementById("login-username").value;
  var senha = document.getElementById("login-password").value;

  // Substitua pela URL do seu Apps Script
  var url = "https://script.google.com/macros/s/AKfycbx_c2BF6GlxNMnpK9hlZlHEJ5WNAjiIJa1Ntugu3J6FpIWrriFhjoPB8STYDSx-0xRbNw/exec";

  showLoading('Entrando...');
  fetch(url + `?action=login&usuario=${encodeURIComponent(usuario)}&senha=${encodeURIComponent(senha)}`)
    .then(res => res.json())
    .then(data => {
      hideLoading();
      if (data.success) {
        sessionStorage.setItem("usuarioLogado", "true");
        document.getElementById("login-screen").style.display = "none";
      } else {
        document.getElementById("login-error").innerText = "Usu√°rio ou senha inv√°lidos";
      }
    })
    .catch(err => {
      hideLoading();
      console.error("Erro ao realizar login:", err);
      document.getElementById("login-error").innerText = "Erro na conex√£o";
    });
}

      (function(){
        // --- CONFIGURE AQUI a URL do seu Apps Script (cole sua URL publicada) ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx_c2BF6GlxNMnpK9hlZlHEJ5WNAjiIJa1Ntugu3J6FpIWrriFhjoPB8STYDSx-0xRbNw/exec";
        // --------------------------------------------------------------------

        const PRECO_FRANGO_ASSADO = 49.90;
        const PRECO_COXA_SOBRECOXA = 9.90;
        const PRECO_REFRIGERANTE = 10.00;
        const PRECO_ARROZ = 8.00; // novo

        const $$ = Dom7; // Framework7 Dom7

        // habilitar/desabilitar quantidades quando checkbox mudar
        $$('#chk-frango').on('change', () => {
          $$('#qtd-frango').prop('disabled', !$$('#chk-frango').prop('checked'));
          atualizarPrecoTotal();
        });
        $$('#chk-coxa').on('change', () => {
          $$('#qtd-coxa').prop('disabled', !$$('#chk-coxa').prop('checked'));
          atualizarPrecoTotal();
        });
        $$('#qtd-frango, #qtd-coxa').on('input', atualizarPrecoTotal);
        $$('#input-refrigerantes').on('input', atualizarPrecoTotal);
        // === Novo: arroz ===
        $$('#chk-arroz').on('change', () => {
          $$('#qtd-arroz').prop('disabled', !$$('#chk-arroz').prop('checked'));
          atualizarPrecoTotal();
        });
        $$('#qtd-arroz').on('input', atualizarPrecoTotal);

        // === Novo: acrescimo/desconto ===
        $$('#input-acrescimo').on('input', atualizarPrecoTotal);


        // Conta refrigerantes a partir do texto (soma os n√∫meros no come√ßo de cada item separado por v√≠rgula).
        function parseRefrigerantes(text){
          if(!text) return 0;
          // divide por v√≠rgula
          const items = text.split(',');
          let total = 0;
          items.forEach(it => {
            it = it.trim();
            // tenta encontrar n√∫mero no come√ßo
            const m = it.match(/^(\d+)\b/);
            if(m) total += parseInt(m[1]);
            // se n√£o tiver n√∫mero e n√£o for vazio, conta como 1 (opcional)
            // else if(it.length>0) total += 1;
          });
          return total;
        }

        function atualizarPrecoTotal(){
          const qtdFrango = parseInt($$('#qtd-frango').val()) || 0;
          const qtdCoxa = parseInt($$('#qtd-coxa').val()) || 0;
          const qtdRefri = parseRefrigerantes($$('#input-refrigerantes').val());
          const qtdArroz = $$('#chk-arroz').prop('checked') ? (parseInt($$('#qtd-arroz').val()) || 0) : 0;
          const acrescimo = parseFloat($$('#input-acrescimo').val()) || 0.00;

          const subtotal = (qtdFrango * PRECO_FRANGO_ASSADO) +
                          (qtdCoxa * PRECO_COXA_SOBRECOXA) +
                          (qtdRefri * PRECO_REFRIGERANTE) +
                          (qtdArroz * PRECO_ARROZ);

          const total = subtotal + acrescimo;
          $$('#input-preco-total').val(total.toFixed(2));
        }

        // extrai data e hora de um datetime-local (string) no formato esperado
        function splitDateTimeLocal(datetimeLocal){
          // datetimeLocal ex: "2025-10-13T12:30"
          if(!datetimeLocal) return {date:'', time:''};
          const [datePart, timePart] = datetimeLocal.split('T');
          // timePart pode ter segundos, removemos
          const timeOnly = (timePart || '').split(':').slice(0,2).join(':');
          return { date: datePart, time: timeOnly };
        }

        // envia pedido
        $$('#btn-add-pedido').off('click');
        $$('#btn-add-pedido').on('click', async () => {
          const nome = $$('#input-nome-cliente').val().trim();
          const endereco = $$('#input-endereco').val().trim();
          const numero = $$('#input-numero').val().trim();
          const cep = $$('#input-cep').val().trim();
          const datetimeLocal = $$('#input-horario-entrega').val();
          const refrigerantesText = $$('#input-refrigerantes').val().trim();

          const qtdFrango = $$('#chk-frango').prop('checked') ? parseInt($$('#qtd-frango').val()) || 0 : 0;
          const qtdCoxa  = $$('#chk-coxa').prop('checked') ? parseInt($$('#qtd-coxa').val()) || 0 : 0;
          const qtdArroz = $$('#chk-arroz').prop('checked') ? parseInt($$('#qtd-arroz').val()) || 0 : 0;
          const qtdRefri = parseRefrigerantes(refrigerantesText);

          const precoTotal = parseFloat($$('#input-preco-total').val()) || 0;
          const acrescimo = parseFloat($$('#input-acrescimo').val()) || 0;
          const observacoes = $$('#input-obs').val().trim();

          if ((qtdFrango + qtdCoxa + qtdRefri + qtdArroz) === 0 || !nome || !endereco || !datetimeLocal) {
            app.dialog.alert('Preencha todos os campos obrigat√≥rios e escolha ao menos um item.');
            return;
          }

          // separa datetime-local em date/time
          const {date: data_entrega, time: horario_entrega} = splitDateTimeLocal(datetimeLocal);

          // monta objeto a enviar
          const body = {
            data_entrega,
            horario_entrega,
            qntd_frango: qtdFrango,
            qntd_sobrecoxa: qtdCoxa,
            qntd_refri: qtdRefri,
            qntd_arroz: qtdArroz,
            nome_cliente: nome,
            endereco,
            numero,
            cep,
            tipo_refrigerante: refrigerantesText,
            observacoes,
            acrescimo,
            preco_total: precoTotal
          };

                  try {
          showLoading('Enviando pedido...');

          // se estivermos editando, chama updateOrder
          if (window.__editingRow) {
            body.action = 'updateOrder';
            body.row = window.__editingRow;

            const form = new URLSearchParams();
            Object.entries(body).forEach(([k,v]) => form.append(k, v === undefined || v === null ? '' : String(v)));

            const res = await fetch(SCRIPT_URL, {
              method: 'POST',
              body: form
            });

            const json = await (async () => { try { return await res.json(); } catch (e) { return null; } })();

            hideLoading();

            if (json && json.sucesso) {
              app.dialog.alert('Pedido atualizado com sucesso!');
            } else {
              console.warn('Resposta updateOrder:', json, res);
              app.dialog.alert('Pedido atualizado (resposta n√£o confirmada). Verifique o console.');
            }

            // limpa estado de edi√ß√£o
            window.__editingRow = null;
            const titleEl = document.querySelector('#popup-add-pedido .navbar .title');
            if (titleEl) titleEl.textContent = 'Novo Pedido';
          } else {
            // criar novo pedido (comportamento anterior)
            body.action = 'addOrder';
            const form = new URLSearchParams();
            Object.entries(body).forEach(([k,v]) => form.append(k, v === undefined || v === null ? '' : String(v)));

            const res = await fetch(SCRIPT_URL, {
              method: 'POST',
              body: form
            });

            // tenta ler resposta
            let json = null;
            try { json = await res.json(); } catch (e) { json = null; }
            console.log('Resposta do script (add):', json || res);
            hideLoading();
            app.dialog.alert('Pedido adicionado com sucesso!');
          }

          // fecha popup e limpa campos...
          app.popup.close('#popup-add-pedido');
          // (resto do c√≥digo de limpeza permanece id√™ntico)
          $$('#chk-frango').prop('checked', false); $$('#qtd-frango').val(0).prop('disabled', true);
            $$('#chk-coxa').prop('checked', false); $$('#qtd-coxa').val(0).prop('disabled', true);
            $$('#chk-arroz').prop('checked', false); $$('#qtd-arroz').val(0).prop('disabled', true);
            $$('#input-refrigerantes').val('');
            $$('#input-nome-cliente').val('');
            $$('#input-endereco').val('');
            $$('#input-numero').val('');
            $$('#input-cep').val('');
            $$('#input-horario-entrega').val('');
            $$('#input-preco-total').val('');
            $$('#input-acrescimo').val('0.00');
            $$('#input-obs').val('');
          carregarPedidosDoDia();
        } catch (err) {
          hideLoading();
          console.error('Erro ao enviar/atualizar pedido:', err);
          app.dialog.alert('Erro ao enviar pedido. Verifique a conex√£o ou o URL do script.');
        }

        });

        // Ajustar m√≠nimo do datetime-local: busca pedidos do dia e calcula min = √∫ltimo+10min ou agora+10min
        async function ajustarMinHorario(){
          try {
            
            const todayDate = new Date().toISOString().slice(0,10);
            const res = await fetch(`${SCRIPT_URL}?date=${todayDate}`);
            const data = await res.json();
            // data.pedidos expected array
            const pedidos = data.pedidos || data || [];
            let maxTime = null;
            pedidos.forEach(p => {
              const h = p.horario_entrega;
              if(!h) return;
              // if stored as "HH:MM" -> combine with date
              let dt;
              if(typeof h === 'string' && !h.includes('T') && h.match(/^\d{1,2}:\d{2}$/)){
                dt = new Date(`${todayDate}T${h}:00`);
              } else {
                dt = new Date(h);
              }
              if(!isNaN(dt) && (maxTime === null || dt > maxTime)) maxTime = dt;
            });
            const minDate = new Date(Math.max((maxTime?maxTime.getTime():0), Date.now()) + 3*60000);
            const pad = n => String(n).padStart(2,'0');
            const isoLocal = `${minDate.getFullYear()}-${pad(minDate.getMonth()+1)}-${pad(minDate.getDate())}T${pad(minDate.getHours())}:${pad(minDate.getMinutes())}`;
            $$('#input-horario-entrega').attr('min', isoLocal);
            $$('#input-horario-entrega').val(isoLocal);
          } catch (err) {
            console.error('Erro ao ajustar m√≠nimo do hor√°rio:', err);
          }
        }

        async function carregarPedidosDoDia(showOnlyNotDelivered = false) {
          showLoading('Carregando pedidos...');
          try {
            $$('#produtos').html('');
                // ‚úÖ Corrige o fuso hor√°rio (UTC‚àí3 ‚Äî hor√°rio local de S√£o Paulo)
            const now = new Date();
            const offsetMs = now.getTimezoneOffset() * 60 * 1000;
            const localISODate = new Date(now.getTime() - offsetMs).toISOString().slice(0, 10);
            const dateStr = localISODate;
            const res = await fetch(`${SCRIPT_URL}?date=${dateStr}`);
            console.log('URL acessada:', dateStr);
            const data = await res.json();
            const pedidos = (data.pedidos || []);

            // ordenar por horario_entrega (hora)
            pedidos.sort((a, b) => {
              const ta = a.horario_entrega || '';
              const tb = b.horario_entrega || '';
              const ma = (ta.match(/(\d+):(\d+)/) ? parseInt(ta.split(':')[0]) * 60 + parseInt(ta.split(':')[1]) : 0);
              const mb = (tb.match(/(\d+):(\d+)/) ? parseInt(tb.split(':')[0]) * 60 + parseInt(tb.split(':')[1]) : 0);
              return ma - mb;
            });

            let pedidosParaMostrar = pedidos;
            if (showOnlyNotDelivered) {
              pedidosParaMostrar = pedidos.filter(p => {
                // Normaliza o valor de 'entregue' (boolean, string, n√∫mero etc.)
                const val = String(p.entregue || '').trim().toLowerCase();
                return val === '' || val === 'false' || val === '0' || val === 'n√£o' || val === 'nao';
              });
            }

            if (pedidosParaMostrar.length === 0) {
              $$('#produtos').html('<div class="block"><p>Nenhum pedido para hoje.</p></div>');
              return;
            }

            // mapa row -> pedido (√∫til para edi√ß√£o)
            window.__pedidosMap = {}; 


            // monta cards ‚Äî important√≠ssimo: usar p._sheetRow (linha da planilha) para data-row
            pedidosParaMostrar.forEach((p, i) => {
              const sheetRow = p._sheetRow || (i + 2); // fallback se n√£o existir _sheetRow
              // guarda objeto para edi√ß√£o posterior
              window.__pedidosMap[sheetRow] = p;

              const qtdFrango = p.qntd_frango || p.qtd_frango || 0;
              const qtdCoxa = p.qntd_sobrecoxa || p.qtd_sobrecoxa || 0;
              const qtdRefri = p.qntd_refri || p.qtd_refri || 0;
              const preco = parseFloat(p.preco_total || p.precoTotal || p.preco || 0).toFixed(2);

              const items = [];
              if (qtdFrango) items.push(`Frango: ${qtdFrango}`);
              if (qtdCoxa) items.push(`Coxa: ${qtdCoxa}`);
              if (qtdRefri) items.push(`Refri: ${qtdRefri}`);

              const horaAjustada = p.horario_entrega || '';

              const card = `
                <div class="card pedido-card" data-row="${sheetRow}" data-id="${i}">
                  <div class="card-header flex justify-between items-center">
                    <div class="pedido-itens">
                      <b>${items.join(' ‚Ä¢ ')}</b>
                    </div>
                  
                    <a href="#" class="button button-small btn-edit" data-row="${sheetRow}">‚úèÔ∏è Editar</a>
                    <div class="checkbox-container">
                      <label class="checkbox-label">
                        <input type="checkbox" class="chk-entregue" ${p.entregue ? 'checked' : ''}>
                        <span>Entregue</span>
                      </label>
                      <label class="checkbox-label">
                        <input type="checkbox" class="chk-pago" ${p.pago ? 'checked' : ''}>
                        <span>Pago</span>
                      </label>
                       </div>
                  </div>
                  <div class="card-content card-content-padding">
                    <p><b>Cliente:</b> ${p.nome_cliente || p.nome || '-'}</p>
                    <p><b>Endere√ßo:</b> ${p.endereco || '-'}</p>
                    <p><b>Hor√°rio:</b> ${horaAjustada}</p>
                    <p><b>Total:</b> R$ ${preco}</p>
                    ${p.tipo_refrigerante ? `<p class="obs"><b>Obs:</b> ${p.tipo_refrigerante}</p>` : ''}
                  </div>
                </div>
              `;

              $$('#produtos').append(card);
            });

            // === √∫nico handler delegado para todos os checkboxes (evita binds m√∫ltiplos) ===
            // removemos handlers individuais dentro do forEach e usamos delega√ß√£o
            $$('#produtos').off('change', '.chk-entregue, .chk-pago'); // limpa binds anteriores, por seguran√ßa
            $$('#produtos').on('change', '.chk-entregue, .chk-pago', async function () {
              const $el = $$(this);
              const card = $el.closest('.card');
              const row = card.data('row'); // VAMOS USAR data-row (linha real na planilha)
              const campo = $el.hasClass('chk-entregue') ? 'entregue' : 'pago';
              const valor = $el.prop('checked');

              console.log(`Tentando atualizar linha ${row}, campo ${campo}, valor ${valor}`);

              try {
                // Use GET para updateStatus (ou JSONP se tiver problema de CORS)
                const url = `${SCRIPT_URL}?action=updateStatus&row=${encodeURIComponent(row)}&campo=${encodeURIComponent(campo)}&valor=${encodeURIComponent(valor)}`;
                const resp = await fetch(url);
                // se seu Apps Script responder JSON com CORS, voc√™ conseguir√° ler a resposta:
                let json = null;
                try { json = await resp.json(); } catch (e) { console.warn('Resposta n√£o JSON', e); }
                console.log('updateStatus resposta:', json || resp);
              } catch (err) {
                console.error('Erro ao atualizar status:', err);
                app.dialog.alert('Erro ao salvar mudan√ßa. Verifique a conex√£o.');
                // opcional: reverte o estado no UI se falhar
                $el.prop('checked', !valor);
              }
            });

            // abre popup de edi√ß√£o quando clicar no bot√£o editar de um card
            $$('#produtos').off('click', '.btn-edit'); // garante que n√£o duplique handlers
            $$('#produtos').on('click', '.btn-edit', function (evt) {
              evt.preventDefault();
              const row = $$(this).data('row');
              const pedido = window.__pedidosMap && window.__pedidosMap[row];
              if (!pedido) {
                app.dialog.alert('Dados do pedido n√£o encontrados para edi√ß√£o.');
                return;
              }

              // marca que estamos editando essa linha
              window.__editingRow = row;

              // altera t√≠tulo do popup pra indicar edi√ß√£o
              const titleEl = document.querySelector('#popup-add-pedido .navbar .title');
              if (titleEl) titleEl.textContent = 'Editar Pedido';

              // preenche campos do popup com os valores do pedido
              $$('#input-nome-cliente').val(pedido.nome_cliente || pedido.nome || '');
              $$('#input-endereco').val(pedido.endereco || '');
              $$('#input-numero').val(pedido.numero || '');
              $$('#input-cep').val(pedido.cep || '');
              // hor√°rio => se veio como "HH:MM" e data_entrega est√° presente, junta
              if (pedido.horario_entrega && pedido.data_entrega) {
                const pad = n => String(n).padStart(2,'0');
                const dt = String(pedido.data_entrega).split('T')[0] || String(pedido.data_entrega);
                // tenta colocar no formato datetime-local (sem segundos)
                $$('#input-horario-entrega').val(`${dt}T${pedido.horario_entrega}`);
              } else {
                $$('#input-horario-entrega').val('');
              }

              // quantidades e checkboxes
              const qtdFrango = Number(pedido.qntd_frango || pedido.qtd_frango || 0);
              const qtdCoxa   = Number(pedido.qntd_sobrecoxa || pedido.qtd_sobrecoxa || 0);
              const qtdArroz  = Number(pedido.qntd_arroz || pedido.qtd_arroz || 0);
              const tipoRefri = pedido.tipo_refrigerante || pedido.tipo_refri || pedido.tipoRefri || pedido.tipoRefri || '';

              $$('#chk-frango').prop('checked', qtdFrango > 0);
              $$('#qtd-frango').val(qtdFrango).prop('disabled', !(qtdFrango > 0));

              $$('#chk-coxa').prop('checked', qtdCoxa > 0);
              $$('#qtd-coxa').val(qtdCoxa).prop('disabled', !(qtdCoxa > 0));

              $$('#chk-arroz').prop('checked', qtdArroz > 0);
              $$('#qtd-arroz').val(qtdArroz).prop('disabled', !(qtdArroz > 0));

              $$('#input-refrigerantes').val(tipoRefri);
              $$('#input-acrescimo').val((pedido.acrescimo !== undefined && pedido.acrescimo !== null) ? String(pedido.acrescimo) : '0.00');
              $$('#input-obs').val(pedido.observacoes || '');

              // recalcula pre√ßo s√≥ visualmente
              atualizarPrecoTotal();

              // abre popup
              app.popup.open('#popup-add-pedido');
            });

            // atualiza o widget de produ√ß√£o (mostra vendidos calculados)
            if (typeof updateProductionWidget === 'function') updateProductionWidget();

          } catch (err) {
            console.error('‚ùå Erro ao carregar pedidos do dia:', err);
            $$('#produtos').html('<div class="block"><p>Erro ao carregar pedidos.</p></div>');
          } finally {
            hideLoading();
          }
        }

        // abrir popup: ajustar min
        $$('.popup-open[data-popup="#popup-add-pedido"]').on('click', ajustarMinHorario);

        // carregar ao abrir a p√°gina
        document.addEventListener('DOMContentLoaded', () => {
          carregarPedidosDoDia();
        });

        // Filtro pelo √≠cone de busca
        let filtrando = false;
        let filtrandoEmProgresso = false;

                $$('#btnBuscar').on('click', async () => {
          if (filtrandoEmProgresso) return; // bloqueia cliques simult√¢neos
          filtrandoEmProgresso = true;

          filtrando = !filtrando;

          try {
            showLoading('Aplicando filtro...');
            if (filtrando) {
              $$('#searchIcon').css('color', 'var(--dourado)');
              await carregarPedidosDoDia(true); // aplica filtro
            } else {
              $$('#searchIcon').css('color', 'var(--branco)');
              await carregarPedidosDoDia(false); // remove filtro
            }
          } catch (e) {
            console.error('Erro ao aplicar filtro:', e);
          } finally {
            hideLoading();
            filtrandoEmProgresso = false;
          }
        });




        // expose carregarPedidosDoDia to global (in case other scripts call it)
        window.carregarPedidosDoDia = carregarPedidosDoDia;
        /* ---------- Production widget logic ---------- */

      function getTodayKey() {
        const now = new Date();
        const offsetMs = now.getTimezoneOffset() * 60 * 1000;
        const dateStr = new Date(now.getTime() - offsetMs).toISOString().slice(0,10);
        return dateStr;
      }
      function storageKeyFor(dateStr){ return `produzidos:${dateStr}`; }

      function getProducedCounts(dateStr) {
        const key = storageKeyFor(dateStr || getTodayKey());
        const raw = sessionStorage.getItem(key);
        if(!raw) return { frango:0, coxa:0, refri:0 };
        try { return JSON.parse(raw); } catch(e){ return { frango:0, coxa:0, refri:0 }; }
      }
      function setProducedCounts(dateStr, obj){
        const key = storageKeyFor(dateStr || getTodayKey());
        sessionStorage.setItem(key, JSON.stringify({
          frango: Number(obj.frango||0),
          coxa: Number(obj.coxa||0),
          refri: Number(obj.refri||0)
        }));
      }

      /* soma quantos foram vendidos no dia a partir de window.__pedidosMap (preenchido por carregarPedidosDoDia) */
      function computeSoldCounts() {
        const map = window.__pedidosMap || {};
        let sold = { frango:0, coxa:0, refri:0 };
        Object.values(map).forEach(p => {
          sold.frango += Number(p.qntd_frango || p.qtd_frango || 0) || 0;
          sold.coxa  += Number(p.qntd_sobrecoxa || p.qtd_sobrecoxa || 0) || 0;
          sold.refri += Number(p.qntd_refri || p.qtd_refri || 0) || 0;
        });
        return sold;
      }

      function updateProductionWidget() {
        const dateStr = getTodayKey();
        const prod = getProducedCounts(dateStr);
        const sold = computeSoldCounts();

        const elFrango = document.getElementById('pv-frango');
        const elCoxa = document.getElementById('pv-coxa');
        const elRefri = document.getElementById('pv-refri');

        if(!elFrango || !elCoxa || !elRefri) return;

        elFrango.textContent = `${sold.frango} / ${prod.frango}`;
        elCoxa.textContent  = `${sold.coxa} / ${prod.coxa}`;
        elRefri.textContent = `${sold.refri} / ${prod.refri}`;

        // aplicar alerta (vermelho) quando vendidos >= produzidos (e produzidos > 0)
        elFrango.classList.toggle('alert', (prod.frango>0 && sold.frango >= prod.frango));
        elCoxa.classList.toggle('alert',  (prod.coxa>0  && sold.coxa  >= prod.coxa));
        elRefri.classList.toggle('alert', (prod.refri>0 && sold.refri >= prod.refri));
      }

      /* UI handlers */
      (function productionWidgetSetup(){
        const toggle = document.getElementById('production-toggle');
        const panel = document.getElementById('production-panel');
        const editArea = document.getElementById('produzidos-edit');

        if(!toggle || !panel) return;

        toggle.addEventListener('click', () => {
          panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
          // sempre atualizar quando abrir
          if (panel.style.display === 'block') {
            updateProductionWidget();
          }
        });

        document.getElementById('btn-close-productions').addEventListener('click', () => {
          panel.style.display = 'none';
        });

        document.getElementById('btn-edit-produzidos').addEventListener('click', () => {
          const d = getTodayKey();
          const p = getProducedCounts(d);
          document.getElementById('inp-prod-frango').value = p.frango || 0;
          document.getElementById('inp-prod-coxa').value  = p.coxa  || 0;
          document.getElementById('inp-prod-refri').value = p.refri || 0;
          editArea.style.display = 'block';
        });

        document.getElementById('btn-cancel-produzidos').addEventListener('click', () => {
          editArea.style.display = 'none';
        });

        document.getElementById('btn-save-produzidos').addEventListener('click', () => {
          const fr = parseInt(document.getElementById('inp-prod-frango').value) || 0;
          const cx = parseInt(document.getElementById('inp-prod-coxa').value)  || 0;
          const rf = parseInt(document.getElementById('inp-prod-refri').value) || 0;
          setProducedCounts(getTodayKey(), { frango: fr, coxa: cx, refri: rf });
          editArea.style.display = 'none';
          updateProductionWidget();
        });

        // document.getElementById('btn-reset-produzidos').addEventListener('click', () => {
        //   sessionStorage.removeItem(storageKeyFor(getTodayKey()));
        //   updateProductionWidget();
        // });

        // mostrar painel ao passar o mouse (opcional)
        toggle.addEventListener('mouseenter', () => {
          panel.style.display = 'block';
          updateProductionWidget();
        });
        // e esconder ao sair (n√£o obrigat√≥rio ‚Äî o click ainda controla)
        toggle.addEventListener('mouseleave', () => {
          // opcional: n√£o esconder para evitar fechar enquanto interage
          // panel.style.display = 'none';
        });
      })();

      })();

      document.getElementById("input-endereco").addEventListener("blur", async () => {
        const rua = document.getElementById("input-endereco").value.trim();
        const cidade = "Ribeir√£o Preto";
        const uf = "SP";

        if (!rua) return;

        try {
          // Pesquisa o CEP com base no nome da rua (ViaCEP)
          const url = `https://viacep.com.br/ws/${uf}/${cidade}/${encodeURIComponent(rua)}/json/`;
          const res = await fetch(url);
          const data = await res.json();

          if (Array.isArray(data) && data.length > 0 && data[0].cep) {
            document.getElementById("input-cep").value = data[0].cep;
          } else {
            document.getElementById("input-cep").value = "N√£o encontrado";
          }
        } catch (err) {
          console.error("Erro ao buscar CEP:", err);
          document.getElementById("input-cep").value = "Erro";
        }
      });

    // quando o popup fechar, limpa estado de edi√ß√£o e restaura t√≠tulo
    document.querySelectorAll('#popup-add-pedido .popup-close, #popup-add-pedido .link.popup-close').forEach(el => {
      el.addEventListener('click', () => {
        window.__editingRow = null;
        const titleEl = document.querySelector('#popup-add-pedido .navbar .title');
        if (titleEl) titleEl.textContent = 'Novo Pedido';
      });
    });



    </script>


  
</body>  

</html>