<!DOCTYPE html>
<html>

<head>
    <!-- Required meta tags-->
    <meta charset="utf-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- Color theme for statusbar (Android only) -->
    <meta name="theme-color" content="#2196f3">
    <!-- Your app title -->
    <title>Frango da Mama</title>
    <!-- Path to Framework7 Library Bundle CSS -->
    <link rel="stylesheet" href="lib/framework7-bundle.min.css">
    <!-- CSS PERSONALIZADO PARA MENU-->
    <link rel="stylesheet" href="css/index.css">
    <!--√çcones Material Design-->
    <link rel="stylesheet" href="css/materialdesignicons.min.css">
    <!--√çcones Material Design-->
    <link rel="stylesheet" href="css/remixicon.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<!-- Colar logo antes de carregar os scripts principais (p.ex. antes de framework7-bundle.min.js) -->
<script>
  // Universal loading overlay ‚Äî se o Framework7 existir, usa o preloader; sen√£o, mostra overlay custom
  function showLoading(text) {
    try {
      if (window.app && app.preloader && typeof app.preloader.show === 'function') {
        app.preloader.show();
        return;
      }
    } catch(e){ /* ignore */ }

    if (!document.getElementById('sys-loader')) {
      const ov = document.createElement('div');
      ov.id = 'sys-loader';
      ov.style.position = 'fixed';
      ov.style.left = '0';
      ov.style.top = '0';
      ov.style.right = '0';
      ov.style.bottom = '0';
      ov.style.background = 'rgba(0,0,0,0.45)';
      ov.style.zIndex = 99999;
      ov.style.display = 'flex';
      ov.style.alignItems = 'center';
      ov.style.justifyContent = 'center';
      ov.innerHTML = `<div style="background:#fff;padding:14px 18px;border-radius:10px;display:flex;align-items:center;gap:12px">
        <div class="spin" style="width:22px;height:22px;border:3px solid #ddd;border-top-color:#333;border-radius:50%;animation:spin 0.8s linear infinite"></div>
        <div style="font-weight:600;color:#222">${text||'Carregando...'}</div>
      </div>`;
      document.body.appendChild(ov);
      const s = document.createElement('style');
      s.innerHTML = `@keyframes spin{to{transform:rotate(360deg)}}`;
      document.head.appendChild(s);
    } else {
      const ov = document.getElementById('sys-loader');
      ov.style.display = 'flex';
      // atualiza texto se quiser (procura o div de texto no overlay)
      const textDiv = ov.querySelector('div > div:last-child');
      if (textDiv) textDiv.textContent = text || 'Carregando...';
    }
  }

  function hideLoading() {
    try {
      if (window.app && app.preloader && typeof app.preloader.hide === 'function') {
        app.preloader.hide();
        return;
      }
    } catch(e) { /* ignore */ }

    const ov = document.getElementById('sys-loader');
    if (ov) ov.style.display = 'none';
  }
</script>


</head>

<body>

    <div id="login-screen" class="login-container">
      <h2 class="login-title">Login</h2>
      <input id="login-username" type="text" placeholder="Usu√°rio" class="login-input">
      <input id="login-password" type="password" placeholder="Senha" class="login-input">
      <button id="loginBtn" onclick="realizarLogin()">Entrar</button>
      <p id="login-error" class="login-error"></p>
    </div>




    <!-- App root element -->
    <div id="app">
    <!-- <div id="app" style="display:none;"></div> -->
      
        <!-- Popup para adicionar produto -->

        <div class="popup popup-produto custom-popup-anim" id="popup-add-pedido">
          <div class="view"><div class="page">
            <div class="navbar"><div class="navbar-inner">
              <div class="title">Novo Pedido</div>
              <div class="right"><a href="#" class="link popup-close icon-only"><i class="ri-close-line"></i></a></div>
            </div>
          </div>

             <div class="page-content">
              <div class="block">
                <div class="list no-hairlines-md">
                  <ul>
                    <!-- Nome -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Nome do Cliente</div>
                        <div class="item-input-wrap">
                          <input type="text" id="input-nome-cliente" placeholder="Nome" />
                        </div>
                      </div>
                    </li>

                    <!-- Frango -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">
                          <label><input type="checkbox" id="chk-frango"> Frango Assado (R$49,90)</label>
                        </div>
                        <div class="item-input-wrap">
                          <input type="number" id="qtd-frango" min="0" value="0" disabled />
                        </div>
                      </div>
                    </li>

                    <!-- Coxa -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">
                          <label><input type="checkbox" id="chk-coxa"> Coxa-Sobrecoxa (R$9,90)</label>
                        </div>
                        <div class="item-input-wrap">
                          <input type="number" id="qtd-coxa" min="0" value="0" disabled />
                        </div>
                      </div>
                    </li>

                    <!-- Refrigerantes com chips -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Refrigerantes</div>
                        <div class="item-input-wrap">
                          <!-- √°rea visual de chips -->
                          <div id="refri-chips" class="chips-container" aria-live="polite"></div>

                          <!-- mant√©m o input com o mesmo id para compatibilidade com o seu JS existente -->
                          <input type="hidden" id="input-refrigerantes" name="tipo_refrigerante" value="">

                          <!-- bot√£o para abrir sugest√µes (popup) -->
                          <button type="button" id="btn-refri-sugestoes" class="button button-outline" style="margin-top:8px;">
                            Adicionar Refrigerante
                          </button>
                        </div>
                      </div>
                    </li>

                    <!-- Acompanhamentos com chips -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Acompanhamentos</div>
                        <div class="item-input-wrap">

                          <!-- chips -->
                          <div id="acomp-chips" class="chips-container"></div>

                          <!-- input hidden (OBRIGAT√ìRIO) -->
                          <input
                            type="hidden"
                            id="input-acompanhamentos"
                            name="acompanhamentos"
                            value=""
                          >

                          <button
                            type="button"
                            id="btn-acomp-sugestoes"
                            class="button button-outline"
                            style="margin-top:8px;"
                          >
                            Adicionar Acompanhamento
                          </button>

                        </div>
                      </div>
                    </li>



                    <!-- Acr√©scimo / Desconto (valor em R$) -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Acr√©scimo / Desconto (R$)</div>
                        <div class="item-input-wrap">
                          <!-- usar type="text" + inputmode para permitir '-' e decimal (v√≠rgula ou ponto) -->
                            <input
                              type="text"
                              id="input-acrescimo"
                              placeholder="Ex: 5.00 ou -2.50"
                            />

                        </div>
                      </div>
                    </li>

                    <!-- Observa√ß√µes (campo livre) -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Observa√ß√µes/Contato</div>
                        <div class="item-input-wrap">
                          <textarea id="input-obs" placeholder="Observa√ß√µes do pedido (ex: sem cebola, entrega na porta)"></textarea>
                        </div>
                      </div>
                    </li>

                    

                    <!-- Endere√ßo -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Rua</div>
                        <div class="item-input-wrap">
                          <input type="text" id="input-endereco" placeholder="Digite o nome da rua" />
                        </div>
                      </div>
                    </li>

                    <!-- N√∫mero -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">N√∫mero</div>
                        <div class="item-input-wrap">
                          <input type="text" id="input-numero" placeholder="N√∫mero" />
                        </div>
                      </div>
                    </li>

                    <!-- CEP -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">CEP</div>
                        <div class="item-input-wrap">
                          <input type="text" id="input-cep" placeholder="CEP (pode digitar ou ser√° preenchido automaticamente)" />
                        </div>
                      </div>
                    </li>

                    <!-- Cidade -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Cidade</div>
                        <div class="item-input-wrap">
                          <input type="text" id="input-cidade" value="Ribeir√£o Preto" readonly />
                        </div>
                      </div>
                    </li>

                    <!-- UF -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">UF</div>
                        <div class="item-input-wrap">
                          <input type="text" id="input-uf" value="SP" readonly />
                        </div>
                      </div>
                    </li>

                    <!-- Hor√°rio -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Hor√°rio de Entrega</div>
                        <div class="item-input-wrap">
                          <input id="input-horario-entrega" type="datetime-local" />
                        </div>
                      </div>
                    </li>

                    <!-- Pre√ßo total -->
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Pre√ßo Total (R$)</div>
                        <div class="item-input-wrap">
                          <input type="number" id="input-preco-total" readonly />
                        </div>
                      </div>
                    </li>
                  </ul>
                </div>

                <div class="block">
                  <a href="#" class="button button-fill" id="btn-add-pedido">Adicionar Pedido</a>
                </div>
              </div>
            </div>

          </div></div>
        </div>


        <!-- Your main view, should have "view-main" class -->
        <div class="view view-main">
          <div class="toolbar toolbar-bottom">
            <div class="toolbar-inner display-flex">
              <a href="/loadingindex/" class="tab-link link active"><i class="ri-restaurant-line"></i><span>Pedidos</span></a>
              <a href="/loadinglink2/" class="tab-link link"><i class="ri-map-pin-line"></i><span>Rotas</span></a>
              <a href="/loadinglink3/" class="tab-link link"><i class="ri-wallet-3-line"></i><span>Financeiro</span></a>
              <a href="/loadinglink4/" class="tab-link link"><i class="ri-settings-3-line"></i><span>Configura√ß√µes</span></a>
            </div>
          </div>

          <div data-name="index" class="page color-theme-blue">
            <div class="navbar"><div class="navbar-bg"></div><div class="navbar-inner">
              <div class="left">
                <a href="#" class="link icon-only popup-open" data-popup="#popup-add-pedido">
                  <i class="ri-add-line"></i>
                </a>
              </div>
              <div class="title" id="app-title">Frango da Mama</div>
              <div class="right">
                <a href="#" class="link icon-only" id="btnBuscar"><i id="searchIcon" class="ri-filter-3-line"></i></a>
              </div>
            </div></div>

            <div class="page-content ptr-content">
              <div id="preloader" style="display:none;text-align:center;margin:20px 0;"><div class="preloader"></div></div>
              <div id="produtos" class="block grid grid-cols-1 gap-2 card-list" style="padding:10px;"></div>
            </div>
          </div>
        </div>
      </div>

    <!-- Production widget (floating) -->
    <div id="production-widget" aria-hidden="false">
      <div id="production-panel" role="dialog" aria-label="Produ√ß√£o e vendas do dia">
        <div class="prod-row"><div class="prod-label">üêî Frango</div><div class="prod-value" id="pv-frango">0 / 0</div></div>
        <div class="prod-row"><div class="prod-label">üçó Coxa</div><div class="prod-value" id="pv-coxa">0 / 0</div></div>
        <div class="prod-row"><div class="prod-label">ü•§ Coca-Cola Original</div><div class="prod-value" id="pv-coca-original">0 / 0</div></div>
        <div class="prod-row"><div class="prod-label">ü•§ Coca-Cola Zero</div><div class="prod-value" id="pv-coca-zero">0 / 0</div></div>
        <div class="prod-row"><div class="prod-label">ü•§ Cotuba</div><div class="prod-value" id="pv-cotuba">0 / 0</div></div>

        <div class="actions">
          <div style="display:flex; gap:6px;">
            <button id="btn-edit-produzidos" class="small-btn">Editar</button>
            <!-- <button id="btn-reset-produzidos" class="small-btn" title="Limpar produzidos do dia">Reset</button> -->
          </div>
          <button id="btn-close-productions" class="link-text">‚ùå</button>
        </div>

        <div id="produzidos-edit" style="display:none; margin-top:8px;">
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px;">
            <label style="min-width:80px;">üêî Frangos</label>
            <input type="number" id="inp-prod-frango" min="0" value="0">
          </div>
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px;">
            <label style="min-width:80px;">üçó Coxas</label>
            <input type="number" id="inp-prod-coxa" min="0" value="0">
          </div>
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px;">
            <label style="min-width:80px;">ü•§ Coca Original</label>
            <input type="number" id="inp-prod-coca-original" min="0" value="0">
          </div>
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px;">
            <label style="min-width:80px;">ü•§ Coca Zero</label>
            <input type="number" id="inp-prod-coca-zero" min="0" value="0">
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <label style="min-width:80px;">ü•§ Cotuba</label>
            <input type="number" id="inp-prod-cotuba" min="0" value="0">
          </div>
          <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
            <button id="btn-save-produzidos" class="small-btn">Salvar</button>
            <button id="btn-cancel-produzidos" class="small-btn">Cancelar</button>
          </div>
        </div>
      </div>

      <div id="production-toggle" title="Produ√ß√£o e Vendas">üìä</div>
    </div>
  
    <!-- Path to Framework7 Library Bundle JS-->
    <script type="text/javascript" src="lib/framework7-bundle.min.js"></script>
	  <!-- jQuery -->
	  <script type="text/javascript" src="lib/jquery-3.7.0.min.js"></script>	
    <script src="js/funcoes.js"></script>
    <!-- Roteamento do app-->
    <script type="text/javascript" src="js/routes.js"></script>
    <script src="cordova.js"></script>

    <script>
      app.ptr.done(); // usa o app j√° existente
  
      // Usar Dom7 (o "jQuery" do Framework7)
      var $$ = Dom7;
  
      // Evento quando o usu√°rio puxa para atualizar
      $$('.ptr-content').on('ptr:pullstart', function (e) {
        // Quando come√ßa a puxar, mostra preloader
        $$('#preloader').show();
      });

      $$('.ptr-content').on('ptr:pullmove', function (e, distance) {
        // Opcional: voc√™ pode ajustar a opacidade ou o tamanho do preloader conforme a dist√¢ncia
        const max = 100; // distancia m√°xima considerada
        const perc = Math.min(distance / max, 1);
        $$('#preloader').css('opacity', perc);
      });

      $$('.ptr-content').on('ptr:pullend', function (e) {
        // Quando o usu√°rio solta, restaura opacidade
        $$('#preloader').css('opacity', 1);
      });

      $$('.ptr-content').on('ptr:refresh', function (e) {
        // Simula carregamento
        setTimeout(function () {
            if (window.carregarPedidosDoDia) window.carregarPedidosDoDia();
            $$('#preloader').hide();
            app.ptr.done();
        }, 1500);
      });


    </script>

    <script>

      document.addEventListener('DOMContentLoaded', function () {
        // Mostrar preloader inicialmente
        $$('#preloader').show();

        // Simula um delay (voc√™ pode remover o setTimeout depois se quiser)
        setTimeout(() => {
          $$('#preloader').hide(); // Esconde o preloader depois do carregamento
        }, 2000); // tempo simulado para carregamento
      });

      // Esconde os cards ao sair da p√°gina index
      $$(document).on('page:beforeout', '.page[data-name="index"]', function () {
        console.log('Saindo da index, ocultando cards');
        $$('#produtos').hide();
      });

      // Mostra os cards ao retornar para a p√°gina index
      $$(document).on('page:afterin', '.page[data-name="index"]', function () {
        console.log('Voltando para index, mostrando cards');
        $$('#produtos').show();
      });
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Verifica se o usu√°rio j√° est√° logado na sess√£o atual
        const logado = sessionStorage.getItem("usuarioLogado");

        if (logado === "true") {
          // Oculta a tela de login e mostra o conte√∫do
          document.getElementById("login-screen").style.display = "none";
          //document.getElementById("app-content").style.display = "block";
        } else {
          // Mostra a tela de login
          document.getElementById("login-screen").style.display = "block";
          //document.getElementById("app-content").style.display = "none";
        }
      });

function realizarLogin() {
  var usuario = document.getElementById("login-username").value;
  var senha = document.getElementById("login-password").value;

  // Substitua pela URL do seu Apps Script
  var url = "https://script.google.com/macros/s/AKfycby9TeyCIJOq-f3BcGCzraAgObA5rtrhCOxcHvYQ4A7Vo5e5T7nDsVCzSlzWp9SeXo0ifg/exec";

  showLoading('Entrando...');
  fetch(url + `?action=login&usuario=${encodeURIComponent(usuario)}&senha=${encodeURIComponent(senha)}`)
    .then(res => res.json())
    .then(data => {
      hideLoading();
      if (data.success) {
        sessionStorage.setItem("usuarioLogado", "true");
        document.getElementById("login-screen").style.display = "none";
      } else {
        document.getElementById("login-error").innerText = "Usu√°rio ou senha inv√°lidos";
      }
    })
    .catch(err => {
      hideLoading();
      console.error("Erro ao realizar login:", err);
      document.getElementById("login-error").innerText = "Erro na conex√£o";
    });
}

// üîπ GLOBAL (obrigat√≥rio)
window.acompanhamentosSelecionados = [];

      (function(){
        // --- CONFIGURE AQUI a URL do seu Apps Script (cole sua URL publicada) ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby9TeyCIJOq-f3BcGCzraAgObA5rtrhCOxcHvYQ4A7Vo5e5T7nDsVCzSlzWp9SeXo0ifg/exec";
        // --------------------------------------------------------------------

        const PRECO_FRANGO_ASSADO = 49.90;
        const PRECO_COXA_SOBRECOXA = 9.90;
        const PRECO_REFRIGERANTE = 10.00;

        const $$ = Dom7; // Framework7 Dom7

        // ====== In√≠cio: c√≥digo para chips de refrigerante ======
const refriOpcoes = ["coca-cola original", "coca-cola zero", "cotuba"];
let refriSelecionados = []; // array com strings (cada item representa 1 unidade escolhida

const ACOMPANHAMENTOS = {
  arroz: { nome: 'Arroz', preco: 10 },
  maionese: { nome: 'Maionese', preco: 20 },
  mandioca: { nome: 'Mandioca', preco: 15 }
};

window.atualizarChipsAcompanhamentos = function () {
  const container = document.getElementById('acomp-chips');
  if (!container) return;

  container.innerHTML = '';

  window.acompanhamentosSelecionados.forEach((item, index) => {
    const chip = document.createElement('div');
    chip.className = 'chip chip-outline';

    chip.innerHTML = `
      <div class="chip-label">
        ${item.nome} (R$ ${item.preco.toFixed(2).replace('.', ',')})
      </div>
      <a class="chip-delete"></a>
    `;

    chip.querySelector('.chip-delete').onclick = () => {
      window.acompanhamentosSelecionados.splice(index, 1);
      window.atualizarChipsAcompanhamentos();
      atualizarPrecoTotal();
    };

    container.appendChild(chip);
  });

  $$('#input-acompanhamentos').val(
    window.acompanhamentosSelecionados.map(a => a.nome).join(', ')
  );
};


function addAcompanhamento(key) {
  const acomp = ACOMPANHAMENTOS[key];
  if (!acomp) {
    console.warn('Acompanhamento inv√°lido:', key);
    return;
  }

  window.acompanhamentosSelecionados.push({
    nome: acomp.nome,
    preco: acomp.preco
  });

  window.atualizarChipsAcompanhamentos();
  atualizarPrecoTotal();
}

$$('#btn-acomp-sugestoes').on('click', function () {
  const buttons = Object.keys(ACOMPANHAMENTOS).map(key => {
    const a = ACOMPANHAMENTOS[key];
    return {
      text: `${a.nome} ‚Äî R$ ${a.preco.toFixed(2).replace('.', ',')}`,
      onClick: () => addAcompanhamento(key)
    };
  });

  app.actions.create({
    buttons: [
      buttons,
      [{ text: 'Cancelar', color: 'red' }]
    ]
  }).open();
});




// refs DOM (ser√£o encontradas dentro do popup)
const chipsContainer = document.getElementById('refri-chips');
const hiddenInputRefri = document.getElementById('input-refrigerantes');
const btnSugestoes = document.getElementById('btn-refri-sugestoes');

// adiciona op√ß√£o (pode ser chamada v√°rias vezes)
function addRefrigerante(nome) {
  refriSelecionados.push(nome);
  syncInputRefrigerantes();
  atualizarPrecoTotal();
}

function syncInputRefrigerantes() {
  $$('#input-refrigerantes').val(refriSelecionados.join(', '));
}


// remove pelo √≠ndice
function removerRefrigerante(index) {
  refriSelecionados.splice(index, 1);
  syncInputRefrigerantes();
  atualizarPrecoTotal();
}

// reconstr√≥i DOM dos chips
function atualizarChips() {
  if (!chipsContainer) return;
  chipsContainer.innerHTML = '';
  refriSelecionados.forEach((r, i) => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.innerHTML = `<span class="count">1√ó</span><span class="label">${r}</span><span class="close-chip" data-i="${i}">&times;</span>`;
    chipsContainer.appendChild(chip);
    atualizarPrecoTotal();
  });
  // listeners dos X
  chipsContainer.querySelectorAll('.close-chip').forEach(el => {
    el.addEventListener('click', (ev) => {
      const idx = Number(ev.currentTarget.dataset.i);
      removerRefrigerante(idx);
    });
    atualizarPrecoTotal();
  });
  atualizarPrecoTotal();
}

// monta string tipo: "1 Coca-Cola Original, 2 Cotuba"
function atualizarHiddenInput() {
  if (!hiddenInputRefri) return;
  const mapa = {};
  refriSelecionados.forEach(r => mapa[r] = (mapa[r] || 0) + 1);
  const partes = Object.entries(mapa).map(([nome, qnt]) => `${qnt} ${nome}`);
  hiddenInputRefri.value = partes.join(', ');
  // Dispara evento input (caso algum handler antigo esteja escutando)
  const ev = new Event('input', { bubbles: true, cancelable: true });
  hiddenInputRefri.dispatchEvent(ev);
}

// Abre um popup simples com as op√ß√µes (usa Framework7 popup)
if (btnSugestoes) {
  btnSugestoes.addEventListener('click', () => {
    const listHtml = refriOpcoes
      .map(op => `
        <li class="popup-refri-item" data-valor="${op}" 
            style="padding: 12px; font-size: 17px; background: #ffffff; border-bottom: 1px solid #ccc; color: #333; cursor: pointer;">
          ${op}
        </li>
      `)
      .join('');

    const popupHtml = `
      <div class="popup" id="popup-refri-sugestoes" style="background: #f5f5f5;">
        <div class="view">
          <div class="page">

            <!-- NAVBAR -->
            <div class="navbar" style="background: #ffffff; border-bottom: 1px solid #ccc;">
              <div class="navbar-inner">

                <div class="title" style="color: #333; font-weight: 600;">
                  Escolher Refrigerante
                </div>

                <div class="right">
                  <a href="#" class="link popup-close"
                     style="font-size: 20px; font-weight: bold; color: red;">
                    X
                  </a>
                </div>

              </div>
            </div>

            <!-- LISTA -->
            <div class="page-content" style="background: #f5f5f5;">
              <div class="list simple-list">
                <ul>${listHtml}</ul>
              </div>
            </div>

          </div>
        </div>
      </div>
    `;

    const pop = app.popup.create({ content: popupHtml });
    pop.open();

    // EVENTO DE CLIQUE NAS OP√á√ïES
    document.querySelectorAll('#popup-refri-sugestoes .popup-refri-item').forEach(el => {
      el.addEventListener('click', (e) => {
        const val = e.currentTarget.dataset.valor;
        addRefrigerante(val);
        pop.close();
      });
    });
  });
}

// Se o hidden for preenchido (por edit), sincroniza chips com o value
function syncChipsFromHidden() {
  const v = (hiddenInputRefri && hiddenInputRefri.value) ? String(hiddenInputRefri.value).trim() : '';
  if (!v) { refriSelecionados = []; atualizarChips(); return; }
  // aceita formatos: "1 Coca, 2 Fanta" ou "Coca, Fanta" etc.
  const parts = v.split(',').map(s => s.trim()).filter(Boolean);
  const newArr = [];
  parts.forEach(p => {
    const m = p.match(/^(\d+)\s+(.*)$/);
    if (m) {
      const q = Number(m[1]);
      const nome = m[2].trim();
      for (let i=0;i<q;i++) newArr.push(nome);
    } else {
      // sem n√∫mero: cada entrada conta como 1
      newArr.push(p);
    }
  });
  refriSelecionados = newArr;
  atualizarChips();
}

// Quando o popup de pedido abrir, sincroniza chips (√∫til para edi√ß√£o)
$$(document).on('popup:opened', '#popup-add-pedido', function () {
  syncChipsFromHidden();
});

// garantindo que se algu√©m setar o hidden programaticamente, sincronizamos (observer leve)
if (hiddenInputRefri) {
  // captura mudan√ßas de value via setInterval leve (inofensivo) ‚Äî evita mexer em seu c√≥digo existente
  let lastHiddenVal = hiddenInputRefri.value || '';
  setInterval(() => {
    if (!hiddenInputRefri) return;
    const cur = hiddenInputRefri.value || '';
    if (cur !== lastHiddenVal) {
      lastHiddenVal = cur;
      syncChipsFromHidden();
      // n√£o sobrescreve o hidden ‚Äî apenas atualiza UI
    }
  }, 600);
}
// ====== Fim: c√≥digo para chips de refrigerante ======


        // habilitar/desabilitar quantidades quando checkbox mudar
        $$('#chk-frango').on('change', () => {
          $$('#qtd-frango').prop('disabled', !$$('#chk-frango').prop('checked'));
          atualizarPrecoTotal();
        });
        $$('#chk-coxa').on('change', () => {
          $$('#qtd-coxa').prop('disabled', !$$('#chk-coxa').prop('checked'));
          atualizarPrecoTotal();
        });
        $$('#qtd-frango, #qtd-coxa').on('input', atualizarPrecoTotal);
        $$('#input-refrigerantes').on('input', atualizarPrecoTotal);
        // === Novo: acrescimo/desconto ===
        $$('#input-acrescimo').on('input', atualizarPrecoTotal);


        // Conta refrigerantes a partir do texto (soma os n√∫meros no come√ßo de cada item separado por v√≠rgula).
        function parseRefrigerantes(text){
          if(!text) return 0;
          // divide por v√≠rgula
          const items = text.split(',');
          let total = 0;
          items.forEach(it => {
            it = it.trim();
            // tenta encontrar n√∫mero no come√ßo
            const m = it.match(/^(\d+)\b/);
            if(m) total += parseInt(m[1]);
            // se n√£o tiver n√∫mero e n√£o for vazio, conta como 1 (opcional)
            // else if(it.length>0) total += 1;
          });
          return total;
        }

        function parseRefrigerantesLista(texto) {
          if (!texto) return [];
          return texto.split(',')
                      .map(t => t.trim())
                      .filter(t => t.length > 0);
        }


        function calcularPrecoRefrigerantesLista(lista) {
          let total = 0;

          lista.forEach(item => {
            const nome = item.toLowerCase();

            if (nome.includes("cotuba")) {
              total += 8; // Cotuba custa 8
            } else {
              total += 10; // Coca original e zero custam 10
            }
          });

          return total;
        }

        function calcularPrecoAcompanhamentos(lista) {
          if (!Array.isArray(lista)) return 0;

          return lista.reduce((total, item) => {
            const preco = Number(
              String(item.preco || item.valor || 0).replace(',', '.')
            );
            return total + (isNaN(preco) ? 0 : preco);
          }, 0);
        }


        function atualizarPrecoTotal() {
          const qtdFrango = parseInt($$('#qtd-frango').val()) || 0;
          const qtdCoxa = parseInt($$('#qtd-coxa').val()) || 0;

          // üîπ Acrescimo/desconto (continua igual)
          let acrescimo = $$('#input-acrescimo').val().trim();
          acrescimo = acrescimo.replace(',', '.');
          acrescimo = parseFloat(acrescimo);
          if (isNaN(acrescimo)) acrescimo = 0;

          // ‚úÖ FONTE √öNICA ‚Äì refrigerantes
          const listaRefri = Array.isArray(refriSelecionados)
            ? refriSelecionados
            : [];

          // ‚úÖ FONTE √öNICA ‚Äì acompanhamentos
          const listaAcompanhamentos = Array.isArray(window.acompanhamentosSelecionados)
            ? window.acompanhamentosSelecionados
            : [];

          const subtotal =
            (qtdFrango * PRECO_FRANGO_ASSADO) +
            (qtdCoxa * PRECO_COXA_SOBRECOXA) +
            calcularPrecoRefrigerantesLista(listaRefri) +
            calcularPrecoAcompanhamentos(listaAcompanhamentos);

          const total = subtotal + acrescimo;

          // mant√©m padr√£o decimal brasileiro visualmente se quiser
          $$('#input-preco-total').val(total.toFixed(2));
        }


        // extrai data e hora de um datetime-local (string) no formato esperado
        function splitDateTimeLocal(datetimeLocal){
          // datetimeLocal ex: "2025-10-13T12:30"
          if(!datetimeLocal) return {date:'', time:''};
          const [datePart, timePart] = datetimeLocal.split('T');
          // timePart pode ter segundos, removemos
          const timeOnly = (timePart || '').split(':').slice(0,2).join(':');
          return { date: datePart, time: timeOnly };
        }


        function formatarRefrigerantesLista(lista) {
          const mapa = {};
          lista.forEach(item => {
            if (!mapa[item]) mapa[item] = 0;
            mapa[item]++;
          });
          return Object.entries(mapa)
                      .map(([nome, qtd]) => `${qtd} ${nome}`)
                      .join(', ');
        }


        // envia pedido
        $$('#btn-add-pedido').off('click');
        $$('#btn-add-pedido').on('click', async () => {
          const nome = $$('#input-nome-cliente').val().trim();
          const endereco = $$('#input-endereco').val().trim();
          const numero = $$('#input-numero').val().trim();
          const cep = $$('#input-cep').val().trim();
          const datetimeLocal = $$('#input-horario-entrega').val();
          const refrigerantesText = $$('#input-refrigerantes').val().trim();

          const qtdFrango = $$('#chk-frango').prop('checked') ? parseInt($$('#qtd-frango').val()) || 0 : 0;
          const qtdCoxa  = $$('#chk-coxa').prop('checked') ? parseInt($$('#qtd-coxa').val()) || 0 : 0;
          const acompanhamentosText = window.acompanhamentosSelecionados
            .map(a => a.nome)
            .join(', ');
          const listaRefri = refrigerantesText
          ? refrigerantesText.split(',').map(s => s.trim()).filter(s => s.length > 0)
          : [];


          const precoTotal = parseFloat($$('#input-preco-total').val()) || 0;
          let acrescimoText = $$('#input-acrescimo').val().trim().replace(',', '.');
          const acrescimo = parseFloat(acrescimoText) || 0;
          const observacoes = $$('#input-obs').val().trim();

          // --- Verifica√ß√£o de estoque: impede vender mais do que produzido dispon√≠vel ---
          // obt√©m produzidos para hoje
          const produced = getProducedCounts(getTodayKey()); // { frango, coxa, refri }
          const sold = computeSoldCounts(); // soma dos pedidos j√° presentes em window.__pedidosMap

          // se estamos editando um pedido, subtrai a quantidade atual do pedido que est√° sendo editado
          let origFrango = 0, origCoxa = 0;
          if (window.__editingRow && window.__pedidosMap && window.__pedidosMap[window.__editingRow]) {
            const orig = window.__pedidosMap[window.__editingRow];
            origFrango = Number(orig.qntd_frango || orig.qtd_frango || 0);
            origCoxa  = Number(orig.qntd_sobrecoxa || orig.qtd_sobrecoxa || 0);
          }

          // dispo = produzido - (vendido - originalDoPedidoEditado)
          const availableFrango = (Number(produced.frango || 0) > 0)
            ? Math.max(Number(produced.frango || 0) - (sold.frango - origFrango), 0)
            : Infinity; // se n√£o produziu (0), consideramos ilimitado

          const availableCoxa = (Number(produced.coxa || 0) > 0)
            ? Math.max(Number(produced.coxa || 0) - (sold.coxa - origCoxa), 0)
            : Infinity;

          // Checa frango
          if (Number(qtdFrango || 0) > availableFrango) {
            if (availableFrango === Infinity) {
              // se infinito, passa (n√£o deveria ocorrer); caso queira bloquear sempre, remova Infinity l√≥gica
            } else {
              app.dialog.alert(`N√£o h√° frangos suficientes dispon√≠veis. Dispon√≠vel: ${availableFrango}.`);
              hideLoading();
              return;
            }
          }

          // Checa coxa
          if (Number(qtdCoxa || 0) > availableCoxa) {
            if (availableCoxa === Infinity) {
              // idem
            } else {
              app.dialog.alert(`N√£o h√° coxas suficientes dispon√≠veis. Dispon√≠vel: ${availableCoxa}.`);
              hideLoading();
              return;
            }
          }


          if (!nome || !endereco || !datetimeLocal) {
            app.dialog.alert('Preencha todos os campos obrigat√≥rios e escolha ao menos um item.');
            return;
          }

          // separa datetime-local em date/time
          const {date: data_entrega, time: horario_entrega} = splitDateTimeLocal(datetimeLocal);

          // monta objeto a enviar
          const body = {
            data_entrega,
            horario_entrega,
            qntd_frango: qtdFrango,
            qntd_sobrecoxa: qtdCoxa,
            qntd_refri: listaRefri.length,
            nome_cliente: nome,
            endereco,
            numero,
            cep,
            tipo_refrigerante: refrigerantesText,
            acompanhamentos: acompanhamentosText,   // üî• ESSENCIAL
            observacoes,
            acrescimo,
            preco_total: precoTotal
          };

                  try {
                    // Garantir que o campo chegue com varia√ß√µes de nome (compatibilidade com server antigo)
const refrigerantesFormatados = formatarRefrigerantesLista(listaRefri);

body.tipo_refrigerante = refrigerantesFormatados;
body.refrigerantes = refrigerantesFormatados;
body.tipoRefrigerante = refrigerantesFormatados;


          showLoading('Enviando pedido...');



          // se estivermos editando, chama updateOrder
          if (window.__editingRow) {
            body.action = 'updateOrder';
            body.row = window.__editingRow;
            // DEBUG: inspeciona o body antes do envio (coloque aqui para testar)
            console.log('[DEBUG] body antes de updateOrder:', body);


            const form = new URLSearchParams();
            Object.entries(body).forEach(([k,v]) => form.append(k, v === undefined || v === null ? '' : String(v)));

            const res = await fetch(SCRIPT_URL, {
              method: 'POST',
              body: form
            });

            const json = await (async () => { try { return await res.json(); } catch (e) { return null; } })();

            hideLoading();



            if (json && json.sucesso) {
              app.dialog.alert('Pedido atualizado com sucesso!');
            } else {
              console.warn('Resposta updateOrder:', json, res);
              app.dialog.alert('Pedido atualizado (resposta n√£o confirmada). Verifique o console.');
            }

            // limpa estado de edi√ß√£o
            window.__editingRow = null;
            const titleEl = document.querySelector('#popup-add-pedido .navbar .title');
            if (titleEl) titleEl.textContent = 'Novo Pedido';
          } else {
            // criar novo pedido (comportamento anterior)
            body.action = 'addOrder';
            const form = new URLSearchParams();
            Object.entries(body).forEach(([k,v]) => form.append(k, v === undefined || v === null ? '' : String(v)));

            const res = await fetch(SCRIPT_URL, {
              method: 'POST',
              body: form
            });

            // tenta ler resposta
            let json = null;
            try { json = await res.json(); } catch (e) { json = null; }
            console.log('Resposta do script (add):', json || res);
            hideLoading();
            app.dialog.alert('Pedido adicionado com sucesso!');
          }

          // fecha popup e limpa campos...
          app.popup.close('#popup-add-pedido');
          // (resto do c√≥digo de limpeza permanece id√™ntico)
          $$('#chk-frango').prop('checked', false); $$('#qtd-frango').val(0).prop('disabled', true);
            $$('#chk-coxa').prop('checked', false); $$('#qtd-coxa').val(0).prop('disabled', true);
            $$('#input-refrigerantes').val('');
            $$('#input-nome-cliente').val('');
            $$('#input-endereco').val('');
            $$('#input-numero').val('');
            $$('#input-cep').val('');
            $$('#input-horario-entrega').val('');
            $$('#input-preco-total').val('');
            $$('#input-acrescimo').val('0.00');
            $$('#input-obs').val('');
          carregarPedidosDoDia();
          // --- notifica rotas sobre novo pedido (colocar logo ap√≥s carregarPedidosDoDia(); ) ---
try {
  // dispara um evento customizado para outras p√°ginas/carregamentos ouvirem
  window.dispatchEvent(new CustomEvent('pedido:adicionado', { detail: { when: Date.now() } }));
  // se a fun√ß√£o carregarPedidos (da p√°gina link2) estiver dispon√≠vel no mesmo contexto, chama direto
  if (typeof window.carregarPedidos === 'function') {
    console.log('[index] notifica rotas: chamando window.carregarPedidos() diretamente');
    try { window.carregarPedidos(); } catch(e) { console.warn('[index] erro ao chamar carregarPedidos():', e); }
  } else {
    // fallback: marca um flag em sessionStorage para que a p√°gina de rotas saiba que precisa recarregar quando for ativada
    sessionStorage.setItem('rotas:refresh_at', String(Date.now()));
    console.log('[index] notifica rotas: flag rotas:refresh_at setada');
  }
} catch (err) {
  console.warn('[index] erro ao notificar rotas sobre novo pedido:', err);
}

        } catch (err) {
          hideLoading();
          console.error('Erro ao enviar/atualizar pedido:', err);
          app.dialog.alert('Erro ao enviar pedido. Verifique a conex√£o ou o URL do script.');
        }

        });

        // Ajustar m√≠nimo do datetime-local: busca pedidos do dia e calcula min = √∫ltimo+10min ou agora+10min
        async function ajustarMinHorario(){
          try {
            
            const todayDate = new Date().toISOString().slice(0,10);
            const res = await fetch(`${SCRIPT_URL}?date=${todayDate}`);
            const data = await res.json();
            // data.pedidos expected array
            const pedidos = data.pedidos || data || [];
            let maxTime = null;
            pedidos.forEach(p => {
              const h = p.horario_entrega;
              if(!h) return;
              // if stored as "HH:MM" -> combine with date
              let dt;
              if(typeof h === 'string' && !h.includes('T') && h.match(/^\d{1,2}:\d{2}$/)){
                dt = new Date(`${todayDate}T${h}:00`);
              } else {
                dt = new Date(h);
              }
              if(!isNaN(dt) && (maxTime === null || dt > maxTime)) maxTime = dt;
            });
            const minDate = new Date(Math.max((maxTime?maxTime.getTime():0), Date.now()) + 3*60000);
            const pad = n => String(n).padStart(2,'0');
            const isoLocal = `${minDate.getFullYear()}-${pad(minDate.getMonth()+1)}-${pad(minDate.getDate())}T${pad(minDate.getHours())}:${pad(minDate.getMinutes())}`;
            $$('#input-horario-entrega').attr('min', isoLocal);
            $$('#input-horario-entrega').val(isoLocal);
          } catch (err) {
            console.error('Erro ao ajustar m√≠nimo do hor√°rio:', err);
          }
        }

        function parseListaTexto(valor) {
          if (!valor) return [];
          return String(valor)
            .split(',')
            .map(v => v.trim())
            .filter(Boolean);
        }


        async function carregarPedidosDoDia(showOnlyNotDelivered = false) {
          showLoading('Carregando pedidos...');
          try {
            $$('#produtos').html('');
                // ‚úÖ Corrige o fuso hor√°rio (UTC‚àí3 ‚Äî hor√°rio local de S√£o Paulo)
            const now = new Date();
            const offsetMs = now.getTimezoneOffset() * 60 * 1000;
            const localISODate = new Date(now.getTime() - offsetMs).toISOString().slice(0, 10);
            const dateStr = localISODate;
            const res = await fetch(`${SCRIPT_URL}?date=${dateStr}`);
            console.log('URL acessada:', dateStr);
            const data = await res.json();
            const pedidos = (data.pedidos || []);

            // ordenar por horario_entrega (hora)
            pedidos.sort((a, b) => {
              const ta = a.horario_entrega || '';
              const tb = b.horario_entrega || '';
              const ma = (ta.match(/(\d+):(\d+)/) ? parseInt(ta.split(':')[0]) * 60 + parseInt(ta.split(':')[1]) : 0);
              const mb = (tb.match(/(\d+):(\d+)/) ? parseInt(tb.split(':')[0]) * 60 + parseInt(tb.split(':')[1]) : 0);
              return ma - mb;
            });

            let pedidosParaMostrar = pedidos;
            if (showOnlyNotDelivered) {
              pedidosParaMostrar = pedidos.filter(p => {
                // Normaliza o valor de 'entregue' (boolean, string, n√∫mero etc.)
                const val = String(p.entregue || '').trim().toLowerCase();
                return val === '' || val === 'false' || val === '0' || val === 'n√£o' || val === 'nao';
              });
            }

            if (pedidosParaMostrar.length === 0) {
              $$('#produtos').html('<div class="block"><p>Nenhum pedido para hoje.</p></div>');
              return;
            }

            // mapa row -> pedido (√∫til para edi√ß√£o)
            window.__pedidosMap = {}; 


            // monta cards ‚Äî important√≠ssimo: usar p._sheetRow (linha da planilha) para data-row
            pedidosParaMostrar.forEach((p, i) => {
              console.log('PEDIDO COMPLETO:', p);

              const sheetRow = p._sheetRow || (i + 2); // fallback se n√£o existir _sheetRow
              // guarda objeto para edi√ß√£o posterior
              window.__pedidosMap[sheetRow] = p;

              const qtdFrango = p.qntd_frango || p.qtd_frango || 0;
              const qtdCoxa = p.qntd_sobrecoxa || p.qtd_sobrecoxa || 0;
              const qtdRefri = p.qntd_refri || p.qtd_refri || 0;
              const preco = parseFloat(p.preco_total || p.precoTotal || p.preco || 0).toFixed(2);

              const items = [];

              // üçó Frango inteiro
              if (qtdFrango) {
                items.push(`Frango: ${qtdFrango}`);
              }

              // üçó Coxa / sobrecoxa
              if (qtdCoxa) {
                items.push(`Coxa: ${qtdCoxa}`);
              }

              // ü•§ Refrigerantes (MOSTRA QUAIS)
              if (p.tipo_refri) {
                items.push(`Refri: ${p.tipo_refri}`);
              }

              // üçö Acompanhamentos
              if (p.acompanhamentos) {
                items.push(`Acomp: ${p.acompanhamentos}`);
              }


              const horaAjustada = p.horario_entrega || '';

              const clienteNome = p.nome_cliente || p.nome || '-';
              const itemsText = items.join(' ‚Ä¢ ') || 'Sem itens';
              const card = `
                <div class="card pedido-card" data-row="${sheetRow}" data-id="${i}">
                  <div class="card-header flex justify-between items-center">
                    <div class="pedido-itens" style="flex:1;">
                      <div style="font-weight:800; font-size:1.05rem; margin-bottom:6px;">${clienteNome}</div>
                      <div style="font-size:0.95rem; color:#666;">${itemsText}</div>
                    </div>

                    <a href="#" class="button button-small btn-edit" data-row="${sheetRow}">‚úèÔ∏è Editar</a>
              <a href="#" class="button button-small btn-delete" data-row="${sheetRow}" style="margin-left:8px;">üóëÔ∏è Apagar</a>
              <div class="checkbox-container">
                      <label class="checkbox-label">
                        <input type="checkbox" class="chk-entregue" ${p.entregue ? 'checked' : ''}>
                        <span>Entregue</span>
                      </label>
                      <label class="checkbox-label">
                        <input type="checkbox" class="chk-pago" ${p.pago ? 'checked' : ''}>
                        <span>Pago</span>
                      </label>
                    </div>
                  </div>
                  <div class="card-content card-content-padding">
              <p><b>Endere√ßo:</b> ${p.endereco || '-'}${p.numero ? `, ${p.numero}` : ''}</p>
                    <p><b>Hor√°rio:</b> ${horaAjustada}</p>
                    <p><b>Total:</b> R$ ${preco}</p>
                    ${p.tipo_refrigerante ? `<p class="obs"><b>Obs:</b> ${p.tipo_refrigerante}</p>` : ''}
                  </div>
                </div>
              `;

              $$('#produtos').append(card);
            });

            // === √∫nico handler delegado para todos os checkboxes (evita binds m√∫ltiplos) ===
            // removemos handlers individuais dentro do forEach e usamos delega√ß√£o
            $$('#produtos').off('change', '.chk-entregue, .chk-pago'); // limpa binds anteriores, por seguran√ßa
            $$('#produtos').on('change', '.chk-entregue, .chk-pago', async function () {
              const $el = $$(this);
              const card = $el.closest('.card');
              const row = card.data('row'); // VAMOS USAR data-row (linha real na planilha)
              const campo = $el.hasClass('chk-entregue') ? 'entregue' : 'pago';
              const valor = $el.prop('checked');

              console.log(`Tentando atualizar linha ${row}, campo ${campo}, valor ${valor}`);

              try {
                // Use GET para updateStatus (ou JSONP se tiver problema de CORS)
                const url = `${SCRIPT_URL}?action=updateStatus&row=${encodeURIComponent(row)}&campo=${encodeURIComponent(campo)}&valor=${encodeURIComponent(valor)}`;
                const resp = await fetch(url);
                // se seu Apps Script responder JSON com CORS, voc√™ conseguir√° ler a resposta:
                let json = null;
                try { json = await resp.json(); } catch (e) { console.warn('Resposta n√£o JSON', e); }
                console.log('updateStatus resposta:', json || resp);
              } catch (err) {
                console.error('Erro ao atualizar status:', err);
                app.dialog.alert('Erro ao salvar mudan√ßa. Verifique a conex√£o.');
                // opcional: reverte o estado no UI se falhar
                $el.prop('checked', !valor);
              }
            });

$$(document).off('click', '.btn-delete');
$$(document).on('click', '.btn-delete', async function (evt) {

  console.log("üî• CLICK NO BTN-DELETE DETECTADO");

  evt.preventDefault();
  const $btn = $$(this);   // <-- cria o $btn corretamente
  const row = $btn.data('row');
  console.log("ROW:", row);

  if (!row) {
    app.dialog.alert("Linha inv√°lida.");
    return;
  }

  const url = `${SCRIPT_URL}?action=deleteOrder&row=${encodeURIComponent(row)}`;

  app.dialog.confirm('Apagar este pedido? Essa opera√ß√£o √© irrevers√≠vel.', async () => {
    try {
      showLoading('Apagando pedido...');
      const res = await fetch(url, { method: 'GET', cache: 'no-store' });

      let json = null;
      try { json = await res.json(); } catch(e) { console.error(e); }

      hideLoading();

      if (json && (json.sucesso || json.success)) {
        $btn.closest('.card').remove();   // <-- agora funciona
        if (typeof updateProductionWidget === 'function') updateProductionWidget();
        app.dialog.alert('Pedido apagado com sucesso.');
      } else {
        app.dialog.alert('N√£o foi poss√≠vel apagar o pedido.');
      }
    } catch (err) {
      hideLoading();
      console.error(err);
      app.dialog.alert('Erro ao apagar pedido.');
    }
  });
});


            // abre popup de edi√ß√£o quando clicar no bot√£o editar de um card
            $$('#produtos').off('click', '.btn-edit'); // garante que n√£o duplique handlers
            $$('#produtos').on('click', '.btn-edit', function (evt) {
              evt.preventDefault();
              const row = $$(this).data('row');
              const pedido = window.__pedidosMap && window.__pedidosMap[row];
              if (!pedido) {
                app.dialog.alert('Dados do pedido n√£o encontrados para edi√ß√£o.');
                return;
              }

              // marca que estamos editando essa linha
              window.__editingRow = row;

              // altera t√≠tulo do popup pra indicar edi√ß√£o
              const titleEl = document.querySelector('#popup-add-pedido .navbar .title');
              if (titleEl) titleEl.textContent = 'Editar Pedido';

              // preenche campos do popup com os valores do pedido
              $$('#input-nome-cliente').val(pedido.nome_cliente || pedido.nome || '');
              $$('#input-endereco').val(pedido.endereco || '');
              $$('#input-numero').val(pedido.numero || '');
              $$('#input-cep').val(pedido.cep || '');
              // hor√°rio => se veio como "HH:MM" e data_entrega est√° presente, junta
              if (pedido.horario_entrega && pedido.data_entrega) {
                const pad = n => String(n).padStart(2,'0');
                const dt = String(pedido.data_entrega).split('T')[0] || String(pedido.data_entrega);
                // tenta colocar no formato datetime-local (sem segundos)
                $$('#input-horario-entrega').val(`${dt}T${pedido.horario_entrega}`);
              } else {
                $$('#input-horario-entrega').val('');
              }

              

              // quantidades e checkboxes
              const qtdFrango = Number(pedido.qntd_frango || pedido.qtd_frango || 0);
              const qtdCoxa   = Number(pedido.qntd_sobrecoxa || pedido.qtd_sobrecoxa || 0);
              
              
              $$('#chk-frango').prop('checked', qtdFrango > 0);
              $$('#qtd-frango').val(qtdFrango).prop('disabled', !(qtdFrango > 0));

              $$('#chk-coxa').prop('checked', qtdCoxa > 0);
              $$('#qtd-coxa').val(qtdCoxa).prop('disabled', !(qtdCoxa > 0));
              // --- Preencher Refrigerantes (robusto) ---
              // --- Preencher Refrigerantes (robusto: parseia "2 Cotuba") ---
              (function fillRefrigerantes() {

  function parseRefrigerantesBR(texto) {
    if (!texto) return [];

    return texto.split(',').map(item => {
      item = item.trim();

      // Caso: "2 Cotuba" ‚Üí vira duas unidades: ["Cotuba","Cotuba"]
      const match = item.match(/^(\d+)\s+(.+)$/);
      if (match) {
        const qtd = parseInt(match[1], 10);
        const nome = match[2];
        return Array(qtd).fill(nome); 
      }

      // Caso: "Cotuba"
      return [item];
    }).flat();
  }

  // tenta pegar o campo correto (sem toLowerCase)
  const valor =
    pedido.tipo_refri ||
    pedido.tipo_refrigerante ||
    pedido.refrigerantes ||
    pedido.refri ||
    pedido.bebidas ||
    pedido.itens ||
    pedido.items ||
    '';

  // agora valor vira uma lista de unidades individuais
  const listaUnidades = parseRefrigerantesBR(valor);

  console.log('[debug] refrigerantes parseados (unidades individuais):', listaUnidades);

  // limpa lista interna
  refriSelecionados = [];

  // adiciona cada unidade separadamente
  listaUnidades.forEach(nome => {
    addRefrigerante(nome);  // mant√©m capitaliza√ß√£o original
  });

  // mostra no campo do formul√°rio cada unidade separada
  $$('#input-refrigerantes').val(listaUnidades.join(', '));

})();

              console.log('[DEBUG pedido keys]', Object.keys(pedido));

              // --- Preencher Acr√©scimo / Desconto (ROBUSTO) ---
              (function fillAcrescimo() {
                // helper: tenta converter string com v√≠rgula ou ponto para Number
                function toNumberBR(v) {
                  if (v === undefined || v === null) return null;
                  const s = String(v).trim();
                  if (s === '') return null;
                  // remove espa√ßos, trocar v√≠rgula por ponto
                  const cleaned = s.replace(/\s+/g, '').replace(',', '.');
                  // remove qualquer caractere que n√£o seja d√≠gito, ponto ou sinal de menos
                  const safe = cleaned.replace(/[^0-9.\-]/g, '');
                  const n = parseFloat(safe);
                  return Number.isFinite(n) ? n : null;
                }

                // poss√≠veis campos onde o acr√©scimo pode estar
                const candidates = [
                  pedido.acrescimo,
                  pedido["acrescimo/desconto"],   // üî¥ ESSENCIAL
                  pedido["Acr√©scimo/Desconto"],
                  pedido["ACRESCIMO/DESCONTO"],
                  pedido.acr√©scimo,
                  pedido.acrescimo_valor,
                  pedido.valor_acrescimo,
                  pedido.desconto,
                  pedido.desconto_valor,
                  pedido.preco_acrescimo,
                  pedido.total_acrescimo
                ];


                // tenta extrair primeiro candidato v√°lido
                let acrescimoNum = null;
                for (let c of candidates) {
                  const n = toNumberBR(c);
                  if (n !== null) { acrescimoNum = n; break; }
                }

                // fallback final
                if (acrescimoNum === null) acrescimoNum = 0;

                // formata para BR (v√≠rgula) e coloca no campo
                const valorFormatado = Number(acrescimoNum).toFixed(2).replace('.', ',');
                $$('#input-acrescimo').val(valorFormatado);

                // logs para debug ‚Äî remova em produ√ß√£o se quiser
                console.log('[debug] preencher acrescimo -> rawCandidates:', candidates, '-> acrescimoNum:', acrescimoNum, '-> exibido:', valorFormatado);
              })();

              // --- Preencher Pre√ßo Total (se existir no pedido) ---
              (function fillPrecoTotal() {
                let preco;

                // tenta pegar pelos nomes mais comuns
                preco = pedido.preco_total ?? pedido.preco ?? pedido.precoTotal ?? null;

                if (preco !== null && preco !== undefined && preco !== "") {
                  const num = Number(preco);
                  if (!isNaN(num)) {
                    // formata para BR (duas casas, v√≠rgula)
                    const valorFormatado = num.toFixed(2).replace('.', ',');
                    $$('#input-preco-total').val(valorFormatado);
                    console.log("[debug] pre√ßo total preenchido:", valorFormatado);
                  }
                } else {
                  $$('#input-preco-total').val('');
                }
              })();

              (function fillAcompanhamento() {
                const valor =
                  pedido.acompanhamento ||
                  pedido.acompanhamentos ||
                  pedido.acomp ||
                  '';

                window.acompanhamentosSelecionados.length = 0; // limpa mantendo refer√™ncia

                if (!valor) {
                  window.atualizarChipsAcompanhamentos();
                  return;
                }

                valor
                  .split(',')
                  .map(v => v.trim().toLowerCase())
                  .filter(Boolean)
                  .forEach(nome => {
                    const acomp = ACOMPANHAMENTOS[nome];
                    if (acomp) {
                      window.acompanhamentosSelecionados.push({
                        nome: acomp.nome,
                        preco: acomp.preco
                      });
                    }
                  });

                window.atualizarChipsAcompanhamentos();
              })();

              
              $$('#input-obs').val(pedido.observacoes || '');

              // recalcula pre√ßo s√≥ visualmente
              atualizarPrecoTotal();
              app.popup.open('#popup-add-pedido');

            });

            

            // atualiza o widget de produ√ß√£o (mostra vendidos calculados)
            if (typeof updateProductionWidget === 'function') updateProductionWidget();

            

          } catch (err) {
            console.error('‚ùå Erro ao carregar pedidos do dia:', err);
            $$('#produtos').html('<div class="block"><p>Erro ao carregar pedidos.</p></div>');
          } finally {
            hideLoading();
          }

          

        }
        // abrir popup: ajustar min
        $$('.popup-open[data-popup="#popup-add-pedido"]').on('click', ajustarMinHorario);

        // carregar ao abrir a p√°gina
        document.addEventListener('DOMContentLoaded', () => {
          carregarPedidosDoDia();
        });

        // Filtro pelo √≠cone de busca
        let filtrando = false;
        let filtrandoEmProgresso = false;

                $$('#btnBuscar').on('click', async () => {
          if (filtrandoEmProgresso) return; // bloqueia cliques simult√¢neos
          filtrandoEmProgresso = true;

          filtrando = !filtrando;

          try {
            showLoading('Aplicando filtro...');
            if (filtrando) {
              $$('#searchIcon').css('color', 'var(--dourado)');
              await carregarPedidosDoDia(true); // aplica filtro
            } else {
              $$('#searchIcon').css('color', 'var(--branco)');
              await carregarPedidosDoDia(false); // remove filtro
            }
          } catch (e) {
            console.error('Erro ao aplicar filtro:', e);
          } finally {
            hideLoading();
            filtrandoEmProgresso = false;
          }
        });




        // expose carregarPedidosDoDia to global (in case other scripts call it)
        window.carregarPedidosDoDia = carregarPedidosDoDia;

// Gera a chave de storage (mantemos igual)
function getTodayKey() {
  const now = new Date();
  const offsetMs = now.getTimezoneOffset() * 60 * 1000;
  const dateStr = new Date(now.getTime() - offsetMs).toISOString().slice(0,10);
  return dateStr;
}
function storageKeyFor(dateStr){ return `produzidos:${dateStr}`; }

// Retorna objeto com chaves: frango, coxa, coca_original, coca_zero, cotuba
function getProducedCounts(dateStr) {
  const key = storageKeyFor(dateStr || getTodayKey());
  const raw = sessionStorage.getItem(key);
  if(!raw) {
    return { frango:0, coxa:0, coca_original:0, coca_zero:0, cotuba:0 };
  }
  try {
    const parsed = JSON.parse(raw);
    // compatibilidade com formato antigo {frango, coxa, refri}
    if (parsed && typeof parsed === 'object') {
      const hasOldRef = ('refri' in parsed) && !('coca_original' in parsed || 'coca_zero' in parsed || 'cotuba' in parsed);
      if (hasOldRef) {
        // tenta mapear o refri antigo para cotuba (fallback) e zera os outros
        return {
          frango: Number(parsed.frango || 0),
          coxa: Number(parsed.coxa || 0),
          coca_original: 0,
          coca_zero: 0,
          cotuba: Number(parsed.refri || 0)
        };
      } else {
        return {
          frango: Number(parsed.frango || 0),
          coxa: Number(parsed.coxa || 0),
          coca_original: Number(parsed.coca_original || parsed.cocaOriginal || 0),
          coca_zero: Number(parsed.coca_zero || parsed.cocaZero || 0),
          cotuba: Number(parsed.cotuba || 0)
        };
      }
    }
  } catch(e) {
    // ignore parse error e retorna defaults
  }
  return { frango:0, coxa:0, coca_original:0, coca_zero:0, cotuba:0 };
}

// Salva novo formato (aceita objeto com as chaves)
function setProducedCounts(dateStr, obj){
  const key = storageKeyFor(dateStr || getTodayKey());
  const payload = {
    frango: Number(obj.frango||0),
    coxa: Number(obj.coxa||0),
    coca_original: Number(obj.coca_original||0),
    coca_zero: Number(obj.coca_zero||0),
    cotuba: Number(obj.cotuba||0)
  };
  sessionStorage.setItem(key, JSON.stringify(payload));
}

// Parser para string de refrigerantes (formatos aceitos: "2 Coca-Cola Original, 1 Cotuba" ou "Coca Zero, Cotuba")
function parseTipoRefriString(s) {
  const out = { coca_original:0, coca_zero:0, cotuba:0, outros:0 };
  if (!s) return out;
  // split por v√≠rgula
  const parts = String(s).split(',').map(p => p.trim()).filter(Boolean);
  parts.forEach(part => {
    // captura quantidade inicial (se existir)
    const m = part.match(/^(\d+)\s+(.*)$/);
    let qty = 1;
    let name = part;
    if (m) { qty = Number(m[1]); name = m[2].trim(); }
    const n = name.toLowerCase();
    if (n.includes('zero') && n.includes('coca')) {
      out.coca_zero += qty;
    } else if (n.includes('cotuba')) {
      out.cotuba += qty;
    } else if (n.includes('coca') || n.includes('cola')) {
      // coca sem "zero" considera original
      out.coca_original += qty;
    } else {
      // se n√£o reconheceu, conta em outros
      out.outros += qty;
    }
  });
  return out;
}

// Soma quantos foram vendidos no dia (agora com contagem por tipo de refrigerante)
function computeSoldCounts() {
  const map = window.__pedidosMap || {};
  // estrutura retornada: { frango, coxa, coca_original, coca_zero, cotuba, outros }
  const sold = { frango:0, coxa:0, coca_original:0, coca_zero:0, cotuba:0, outros:0 };
  Object.values(map).forEach(p => {
    sold.frango += Number(p.qntd_frango || p.qtd_frango || 0) || 0;
    sold.coxa  += Number(p.qntd_sobrecoxa || p.qtd_sobrecoxa || 0) || 0;

    // tenta ler campos poss√≠veis onde o tipo de refrigerante pode estar
    const refStr = p.tipo_refrigerante || p.refrigerantes || p.refri || p.refrigerante || p['tipo_refri'] || '';
    if (refStr) {
      const parsed = parseTipoRefriString(refStr);
      sold.coca_original += parsed.coca_original;
      sold.coca_zero += parsed.coca_zero;
      sold.cotuba += parsed.cotuba;
      sold.outros += parsed.outros;
    } else {
      // fallback: se s√≥ tem qntd_refri num√©rico, soma em 'outros'
      const q = Number(p.qntd_refri || p.qtd_refri || 0) || 0;
      sold.outros += q;
    }
  });
  return sold;
}

// Atualiza o widget de produ√ß√£o (agora mostra 3 contadores de refri)
function updateProductionWidget() {
  const dateStr = getTodayKey();
  const prod = getProducedCounts(dateStr);
  const sold = computeSoldCounts();

  const elFrango = document.getElementById('pv-frango');
  const elCoxa = document.getElementById('pv-coxa');
  const elCocaOrig = document.getElementById('pv-coca-original');
  const elCocaZero = document.getElementById('pv-coca-zero');
  const elCotuba = document.getElementById('pv-cotuba');

  if(!elFrango || !elCoxa || !elCocaOrig || !elCocaZero || !elCotuba) return;

  elFrango.textContent = `${sold.frango} / ${prod.frango}`;
  elCoxa.textContent  = `${sold.coxa} / ${prod.coxa}`;
  elCocaOrig.textContent = `${sold.coca_original} / ${prod.coca_original}`;
  elCocaZero.textContent = `${sold.coca_zero} / ${prod.coca_zero}`;
  elCotuba.textContent = `${sold.cotuba} / ${prod.cotuba}`;

  // aplicar alerta (vermelho) quando vendidos >= produzidos (e produzidos > 0)
  elFrango.classList.toggle('alert', (prod.frango>0 && sold.frango >= prod.frango));
  elCoxa.classList.toggle('alert',  (prod.coxa>0  && sold.coxa  >= prod.coxa));
  elCocaOrig.classList.toggle('alert', (prod.coca_original>0 && sold.coca_original >= prod.coca_original));
  elCocaZero.classList.toggle('alert', (prod.coca_zero>0 && sold.coca_zero >= prod.coca_zero));
  elCotuba.classList.toggle('alert', (prod.cotuba>0 && sold.cotuba >= prod.cotuba));
}

// Setup do widget (popula inputs e salva) ‚Äî substitui o bloco correspondente dentro de productionWidgetSetup()
(function productionWidgetSetup(){
  const toggle = document.getElementById('production-toggle');
  const panel = document.getElementById('production-panel');
  const editArea = document.getElementById('produzidos-edit');

  if(!toggle || !panel) return;

  toggle.addEventListener('click', () => {
    panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
    if (panel.style.display === 'block') {
      updateProductionWidget();
    }
  });

  document.getElementById('btn-close-productions').addEventListener('click', () => {
    panel.style.display = 'none';
  });

  document.getElementById('btn-edit-produzidos').addEventListener('click', () => {
    const d = getTodayKey();
    const p = getProducedCounts(d);
    document.getElementById('inp-prod-frango').value = p.frango || 0;
    document.getElementById('inp-prod-coxa').value  = p.coxa  || 0;
    // novos campos:
    document.getElementById('inp-prod-coca-original').value = p.coca_original || 0;
    document.getElementById('inp-prod-coca-zero').value = p.coca_zero || 0;
    document.getElementById('inp-prod-cotuba').value = p.cotuba || 0;

    editArea.style.display = 'block';
  });

  document.getElementById('btn-cancel-produzidos').addEventListener('click', () => {
    editArea.style.display = 'none';
  });

  document.getElementById('btn-save-produzidos').addEventListener('click', () => {
    const fr = parseInt(document.getElementById('inp-prod-frango').value) || 0;
    const cx = parseInt(document.getElementById('inp-prod-coxa').value)  || 0;
    const co = parseInt(document.getElementById('inp-prod-coca-original').value) || 0;
    const cz = parseInt(document.getElementById('inp-prod-coca-zero').value) || 0;
    const ct = parseInt(document.getElementById('inp-prod-cotuba').value) || 0;
    setProducedCounts(getTodayKey(), { frango: fr, coxa: cx, coca_original: co, coca_zero: cz, cotuba: ct });
    editArea.style.display = 'none';
    updateProductionWidget();
  });

  // mostrar painel ao passar o mouse (opcional)
  toggle.addEventListener('mouseenter', () => {
    panel.style.display = 'block';
    updateProductionWidget();
  });
  toggle.addEventListener('mouseleave', () => {
    // opcional
  });
})();
})();


      document.getElementById("input-endereco").addEventListener("blur", async () => {
        const rua = document.getElementById("input-endereco").value.trim();
        const cidade = "Ribeir√£o Preto";
        const uf = "SP";

        if (!rua) return;

        try {
          // Pesquisa o CEP com base no nome da rua (ViaCEP)
          const url = `https://viacep.com.br/ws/${uf}/${cidade}/${encodeURIComponent(rua)}/json/`;
          const res = await fetch(url);
          const data = await res.json();

          if (Array.isArray(data) && data.length > 0 && data[0].cep) {
            document.getElementById("input-cep").value = data[0].cep;
          } else {
            document.getElementById("input-cep").value = "N√£o encontrado";
          }
        } catch (err) {
          console.error("Erro ao buscar CEP:", err);
          document.getElementById("input-cep").value = "Erro";
        }
      });

    // quando o popup fechar, limpa estado de edi√ß√£o e restaura t√≠tulo
    document.querySelectorAll('#popup-add-pedido .popup-close, #popup-add-pedido .link.popup-close').forEach(el => {
      el.addEventListener('click', () => {
        window.__editingRow = null;
        const titleEl = document.querySelector('#popup-add-pedido .navbar .title');
        if (titleEl) titleEl.textContent = 'Novo Pedido';
      });
    });


function limparFormularioPedido() {
  // limpa acompanhamentos
  window.acompanhamentosSelecionados.length = 0;
  window.atualizarChipsAcompanhamentos();
  $$('#input-acompanhamentos').val('');

  // campos simples
  $$('#input-nome-cliente').val('');
  $$('#input-refrigerantes').val('');
  $$('#input-acrescimo').val('0,00');
  $$('#input-obs').val('');
  $$('#input-endereco').val('');
  $$('#input-numero').val('');
  $$('#input-cep').val('');
  $$('#input-horario-entrega').val('');
  $$('#input-preco-total').val('');

  // checkboxes
  [
    ['#chk-frango', '#qtd-frango'],
    ['#chk-coxa', '#qtd-coxa'],
    ['#chk-arroz', '#qtd-arroz'],
  ].forEach(([chk, qtd]) => {
    $$(chk).prop('checked', false);
    $$(qtd).val(0).prop('disabled', true);
  });
}

    
// Sempre que qualquer popup for fechado, limpa os campos
$$(document).on('popup:closed', '#popup-add-pedido', function () {
  limparFormularioPedido();
});



    </script>


  
</body>  

</html>