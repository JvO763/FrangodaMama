<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#2196f3">
  <title>Frango da Mama</title>
  <link rel="stylesheet" href="lib/framework7-bundle.min.css">
  <link rel="stylesheet" href="css/link2.css">
  <link rel="stylesheet" href="css/materialdesignicons.min.css">
  <link rel="stylesheet" href="css/remixicon.css">
</head>

<body>
  <div id="app">
    <div class="view view-main">
      <!-- Toolbar inferior -->
      <div class="toolbar toolbar-bottom">
        <div class="toolbar-inner display-flex">
          <a href="/loadingindex/" class="tab-link link"><i class="ri-restaurant-line"></i><span>Pedidos</span></a>
          <a href="/loadinglink2/" class="tab-link link active"><i class="ri-map-pin-line"></i><span>Rotas</span></a>
          <a href="/loadinglink3/" class="tab-link link"><i class="ri-user-line"></i><span>Clientes</span></a>
          <a href="/loadinglink4/" class="tab-link link"><i class="ri-settings-3-line"></i><span>Configurações</span></a>
        </div>
      </div>

      <!-- Página principal -->
      <div data-name="link2" class="page color-theme-blue">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="title" id="app-title">Rotas de Entregas</div>
          </div>
        </div>

          <div class="page-content">
            <div class="block">
              <!-- Botão com estilo Framework7 -->
              <a href="#" id="btn-carregar" class="button button-fill">Carregar e Agrupar Entregas</a>
            </div>
            <div class="block" id="lista-grupos"></div>
          </div>
        </div>
    </div>

    <!-- Path to Framework7 Library Bundle JS-->
    <script type="text/javascript" src="lib/framework7-bundle.min.js"></script>
	  <!-- jQuery -->
	  <script type="text/javascript" src="lib/jquery-3.7.0.min.js"></script>	
    <script src="js/funcoes.js"></script>
    <!-- Roteamento do app-->
    <script type="text/javascript" src="js/routes.js"></script>
    <script src="cordova.js"></script>

  <script>
    app.ptr.done(); // usa o app já existente
  
    // Usar Dom7 (o "jQuery" do Framework7)
    var $$ = Dom7;

    // Evento quando o usuário puxa para atualizar
    $$('.ptr-content').on('ptr:refresh', function (e) {
        // Simula uma requisição de rede ou recarregamento
        setTimeout(function () {
            app.ptr.done(); // Finaliza o preload
        });
    });

    // Evento para qualquer página inicializada
    $$(document).on('page:init', function (e) {
      const page = e.detail.page;
      console.log(`Página inicializada: ${page.name}`);

      // Procura todos os botões dentro da página
      $$(page.el).find('a, button').each(function () {
        const btn = $$(this);
        // Adiciona evento de click de debug
        btn.on('click', function () {
          console.log(`Botão clicado na página "${page.name}":`, btn.text() || btn.attr('id') || 'Sem texto/ID');
        });
      });
    });

    // Também adiciona um listener global de click como backup
    document.addEventListener('click', function (e) {
      const el = e.target;
      if (el.tagName === 'BUTTON' || el.tagName === 'A') {
        console.log('Clique detectado globalmente em botão/link:', el.textContent || el.id);
      }
    });

    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxwTVNfu5ks4a1dCVpFkLXtXpmSwgModIS2F55CS26aImwckSaeH_vQWx3RKWPRtxsFWw/exec';

    // Função para carregar pedidos
  // Substitua sua função carregarPedidos atual por esta
  async function carregarPedidos() {
    const container = document.getElementById('lista-grupos');
    container.innerHTML = '<div class="block"><p>Carregando pedidos...</p></div>';
    try {
      // Ajuste de fuso horário (UTC-3) para garantir que "hoje" não vire o dia seguinte após 21h
      const now = new Date();
      const saoPauloDate = new Date(now.getTime() - 3 * 60 * 60 * 1000);
      const today = saoPauloDate.toISOString().slice(0, 10);

      // cache-buster + solicita não usar cache do browser
      const url = `${SCRIPT_URL}?date=${today}&_=${Date.now()}`;

      console.log('[carregarPedidos] fetch ->', url);
      const res = await fetch(url, { cache: 'no-store' });

      console.log('[carregarPedidos] status:', res.status, res.statusText);

      // tenta ler como texto primeiro (para ver possíveis respostas não-JSON)
      const text = await res.text();
      console.log('[carregarPedidos] resposta (raw):', text);

      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        // se não for JSON, tenta ver se o body já é do formato esperado (ex.: diretamente objeto)
        console.warn('[carregarPedidos] corpo não é JSON válido:', e);
        container.innerHTML = `<div class="block"><p>Resposta inesperada do servidor. Veja o console (raw).</p></div>`;
        return;
      }

      const pedidos = data.pedidos || [];
      console.log('[carregarPedidos] pedidos encontrados:', pedidos.length, pedidos);

      if (!pedidos.length) {
        container.innerHTML = '<div class="block"><p>Nenhum pedido encontrado para hoje.</p></div>';
        return;
      }

      const grupos = agruparEntregasMelhorado(pedidos);
      exibirGrupos(grupos);

    } catch (err) {
      console.error('[carregarPedidos] erro:', err);
      container.innerHTML = `<div class="block"><p>Erro ao carregar pedidos. Veja console (CORS / rede / URL).</p></div>`;
      app.dialog.alert('Erro ao carregar pedidos. Verifique console e Network (DevTools).');
    }
  }


    function agruparEntregasMelhorado(entregas) {
      const parseHorario = (p) => {
        if (!p.horario_entrega) return null;
        const baseDate = new Date();
        const [h, m] = String(p.horario_entrega).split(':').map(Number);
        return new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate(), h, m);
      };

      const entregasValidas = entregas
        .filter(e => e.cep && e.horario_entrega && !e.entregue)
        .map(e => ({ ...e, horario: parseHorario(e) }))
        .filter(e => e.horario instanceof Date && !isNaN(e.horario));

      entregasValidas.sort((a, b) => a.horario - b.horario);

      const grupos = [];
      entregasValidas.forEach(entrega => {
        let adicionada = false;
        const horaEntrega = entrega.horario.getTime();
        const cepBase = entrega.cep.substring(0, 5);

        for (const grupo of grupos) {
          if (grupo.length >= 4) continue;

          const horaPrimeiro = grupo[0].horario.getTime();
          const diffMin = Math.abs(horaEntrega - horaPrimeiro) / 60000;
          const cepGrupo = grupo[0].cep.substring(0, 5);

          if (diffMin <= 25 && cepBase === cepGrupo) {
            grupo.push(entrega);
            adicionada = true;
            break;
          }
        }

        if (!adicionada) grupos.push([entrega]);
      });

      return grupos;
    }

    function gerarLinkGoogleMaps(grupo) {
      const cidade = "Ribeirão Preto";
      const uf = "SP";
      const waypointsArray = grupo.map(e =>
        `${e.endereco || ""}, ${e.numero || ""}, ${cidade} - ${uf}, ${e.cep || ""}`
      );
      const baseUrl = "https://www.google.com/maps/dir/?api=1";
      let url = `${baseUrl}&origin=My+Location`;
      const destino = waypointsArray.pop();
      url += `&destination=${encodeURIComponent(destino)}`;
      if (waypointsArray.length > 0) {
        const waypoints = waypointsArray.map(w => encodeURIComponent(w)).join('|');
        url += `&waypoints=${waypoints}`;
      }
      url += "&travelmode=driving";
      return url;
    }

    // Substitui a função antiga
async function marcarComoEntregueByRows(rows) {
  if (!Array.isArray(rows) || rows.length === 0) return;
  try {
    // atualiza em paralelo (mais rápido)
    const promises = rows.map(row => {
      const params = new URLSearchParams({
        action: 'updateStatus',
        row: row,
        campo: 'entregue',
        valor: 'true'
      });
      return fetch(`${SCRIPT_URL}?${params.toString()}`);
    });
    const results = await Promise.all(promises);
    // tenta logar respostas (opcional)
    for (const r of results) {
      try { console.log('updateStatus ok', r.status); } catch(e){}
    }
    app.dialog.alert('Entrega(s) marcada(s) como entregue!');
  } catch (err) {
    console.error('Erro ao marcar entregues em lote:', err);
    app.dialog.alert('Erro ao atualizar entregas.');
  }
}

    // Substitua por esta versão
// --- substituir a função exibirGrupos inteira por esta ---
function exibirGrupos(grupos) {
  const container = document.getElementById('lista-grupos');
  container.innerHTML = '';

  // map row -> pedido (para consulta rápida)
  window.pedidosByRow = {};

  const cores = ['#007bff', '#28a745', '#ffc107', '#17a2b8', '#ff5722', '#6f42c1', '#e83e8c'];

  const toNumber = (v) => { const n = Number((v===undefined||v===null)?0:v); return isNaN(n)?0:n; };
  const isTrue = (v) => { if (v===true||v===1) return true; const s = String(v||'').trim().toLowerCase(); return s==='true'||s==='1'||s==='sim'||s==='yes'; };
  const fmt = (v) => toNumber(v).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  // Preencher pedidosByRow
  grupos.forEach(gr => gr.forEach(p => {
    const row = p._sheetRow || '';
    if (row) window.pedidosByRow[row] = p;
  }));

  grupos.forEach((grupo, i) => {
    const bloco = document.createElement('div');
    bloco.className = 'grupo-entregas';
    bloco.style.background = cores[i % cores.length];
    bloco.style.padding = '12px';
    bloco.style.borderRadius = '10px';
    bloco.style.marginBottom = '12px';
    bloco.dataset.grupoIndex = String(i);

    // calcula total do grupo e se todos estão pagos
    const grupoTotal = grupo.reduce((s, p) => s + toNumber(p.preco_total ?? p.precoTotal ?? p.preco ?? 0), 0);
    const grupoPago = grupo.every(p => isTrue(p.pago));
    const rotaUrl = gerarLinkGoogleMaps(grupo);

    // cabeçalho com elementos identificáveis para atualização posterior
    const headerHTML = `
      <div class="grupo-header" style="display:flex; justify-content: space-between; align-items: center;">
        <div>
          <h3 style="margin:0;">🚚 Rota ${i + 1} (<span class="grupo-count">${grupo.length}</span> entregas)</h3>
          <div style="font-size:0.9rem; margin-top:6px;">
            <strong>Total da rota:</strong> <span class="rota-total">R$ ${fmt(grupoTotal)}</span> &nbsp;•&nbsp;
            <strong>Pago:</strong> <span class="rota-pago">${grupoPago ? 'Sim' : 'Não'}</span>
          </div>
        </div>
        <label class="checkbox-label">
          <input type="checkbox" class="chk-entregue" ${grupo.every(p => isTrue(p.entregue)) ? 'checked' : ''}>
          <span>Entregue</span>
        </label>
      </div>
    `;

    // cria container onde os pedidos ficarão e serão "sortable"
    const listId = `grupo-list-${i}`;
    const pedidosHTML = grupo.map(p => {
      const nome = p.nome_cliente || p.nome || 'Cliente sem nome';
      const endereco = p.endereco ? (p.endereco + (p.numero ? ', ' + p.numero : '')) : '-';
      const cep = p.cep || '---';
      const horario = p.horario_entrega || '';
      const qtdFrango = toNumber(p.qntd_frango ?? p.qtd_frango ?? 0);
      const qtdCoxa = toNumber(p.qntd_sobrecoxa ?? p.qtd_sobrecoxa ?? 0);
      const qtdRefri = toNumber(p.qntd_refri ?? p.qtd_refri ?? 0);
      const qtdArroz = toNumber(p.qntd_arroz ?? p.qtd_arroz ?? 0);
      const tipoRefri = p.tipo_refrigerante ?? p.tipo_refri ?? p.tipoRefri ?? '';
      const preco = toNumber(p.preco_total ?? p.precoTotal ?? p.preco ?? 0);
      const pago = isTrue(p.pago);
      const row = p._sheetRow || '';

      return `
        <div class="pedido-card" data-row="${row}" style="margin-bottom:8px; padding:10px; background: rgba(255,255,255,0.12); border-radius:8px; cursor:grab;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:600;">${nome}</div>
            <div style="font-size:0.9rem;">R$ ${fmt(preco)}</div>
          </div>
          <div style="font-size:0.9rem; margin-top:6px;">
            <div><strong>Endereço:</strong> ${endereco}</div>
            <div><strong>CEP:</strong> ${cep} &nbsp;•&nbsp; <strong>Horário:</strong> ${horario}</div>
            <div style="margin-top:6px;"><strong>Itens:</strong> ${qtdFrango ? `Frango ${qtdFrango}` : ''} ${qtdCoxa ? `• Coxa ${qtdCoxa}` : ''} ${qtdArroz ? `• Arroz ${qtdArroz}` : ''} ${qtdRefri ? `• Refri ${qtdRefri}` : ''}</div>
            ${tipoRefri ? `<div><strong>Tipo refri:</strong> ${tipoRefri}</div>` : ''}
            ${p.observacoes ? `<div style="margin-top:6px;"><strong>Obs:</strong> ${p.observacoes}</div>` : ''}
            <div style="margin-top:6px;"><strong>Pago:</strong> ${pago ? 'Sim' : 'Não'}</div>
          </div>
        </div>
      `;
    }).join('');

    bloco.innerHTML = `
      ${headerHTML}
      <div id="${listId}" class="grupo-list" data-grupo-index="${i}" style="margin-top:10px; min-height:40px;">
        ${pedidosHTML}
      </div>
      <div style="margin-top:10px;">
        <a href="${rotaUrl}" target="_blank" class="btn rota-link">🗺️ Abrir Rota Otimizada</a>
      </div>
    `;

    container.appendChild(bloco);
  });

  // --- Inicializa Sortable em cada lista (permite mover entre grupos) ---
  const listEls = container.querySelectorAll('.grupo-list');
  listEls.forEach(listEl => {
    // eslint-disable-next-line no-undef
    new Sortable(listEl, {
      group: 'entregas',
      animation: 150,
      ghostClass: 'sortable-ghost',
      onEnd: function (evt) {
        // Ao terminar o drag, atualiza totais e links das rotas
        // evt.to é a lista de destino; evt.from lista origem; evt.item foi movido
        updateAllGroupSummariesAndLinks();
        console.log('movido', evt.item.dataset.row, 'para grupo', evt.to.dataset.grupoIndex);
      }
    });
  });

  // Delegado: quando marcar "Entregue" em um grupo, pega linhas atuais daquele grupo do DOM
  container.querySelectorAll('.chk-entregue'); // garante que existam
  container.removeEventListener && container.removeEventListener('change', onGroupEntregueChanged); // só por segurança
  container.addEventListener('change', onGroupEntregueChanged);

  // função local para tratar mudança de "entregue"
  function onGroupEntregueChanged(e) {
    const target = e.target;
    if (!target.classList.contains('chk-entregue')) return;
    const bloco = target.closest('.grupo-entregas');
    if (!bloco) return;
    const listEl = bloco.querySelector('.grupo-list');
    const rows = getRowsFromListEl(listEl);
    if (target.checked) {
      // marcar todas do grupo como entregues (usa a função que faz Promise.all)
      marcarComoEntregueByRows(rows);
      // remove do DOM (comportamento anterior)
      bloco.remove();
    } else {
      // Se desmarcou, opcional: você pode implementar lógica para desfazer na planilha
      console.log('Desmarcou entregue no grupo', bloco.dataset.grupoIndex);
    }
  }

  // atualiza totais e links com base no DOM atual
  function updateAllGroupSummariesAndLinks() {
    const gruposList = container.querySelectorAll('.grupo-entregas');
    gruposList.forEach(grEl => {
      const listEl = grEl.querySelector('.grupo-list');
      const rows = getRowsFromListEl(listEl);
      // recalcula total
      let total = 0;
      let allPaid = true;
      rows.forEach(r => {
        const p = window.pedidosByRow[r];
        if (p) {
          total += toNumber(p.preco_total ?? p.precoTotal ?? p.preco ?? 0);
          if (!isTrue(p.pago)) allPaid = false;
        }
      });
      const rotaTotalEl = grEl.querySelector('.rota-total');
      const rotaPagoEl = grEl.querySelector('.rota-pago');
      const countEl = grEl.querySelector('.grupo-count');
      const rotaLink = grEl.querySelector('.rota-link');

      if (rotaTotalEl) rotaTotalEl.textContent = `R$ ${fmt(total)}`;
      if (rotaPagoEl) rotaPagoEl.textContent = allPaid ? 'Sim' : 'Não';
      if (countEl) countEl.textContent = rows.length;

      // atualiza href do link usando pedidos atuais do DOM
      const grupoObjs = rows.map(r => window.pedidosByRow[r]).filter(Boolean);
      if (rotaLink) {
        rotaLink.href = gerarLinkGoogleMaps(grupoObjs);
      }
    });
  }

  // helper: obtem array de rows (strings/nums) de um elemento list (.grupo-list)
  function getRowsFromListEl(listEl) {
    if (!listEl) return [];
    return Array.from(listEl.children).map(ch => ch.dataset.row).filter(r => r);
  }

  // inicializa os valores (caso o usuário não mova nada)
  updateAllGroupSummariesAndLinks();
}



  document.getElementById('btn-carregar').addEventListener('click', carregarPedidos);

  // limpa botão/handler antigo caso exista (apenas para segurança/compatibilidade)
try {
  const oldBtn = document.getElementById('btn-salvar-grupos');
  if (oldBtn) oldBtn.remove();
  if (window.__saveGruposHandler) delete window.__saveGruposHandler;
} catch (e) { console.warn('limpeza botao salvar error', e); }

  </script>

</body>

<!-- SortableJS para drag & drop entre listas -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

</html>
